
# Docker 规范与注意事项

## **Dockerfile 编写规范**

### 1. 基础镜像选择

```dockerfile
# 推荐：使用官方镜像
FROM node:18-alpine
FROM python:3.11-slim
FROM nginx:alpine

# 避免：使用latest标签
FROM ubuntu:latest  # 不推荐，版本不可控
FROM node:latest    # 不推荐

# 使用固定版本
FROM node:18.20.2-alpine3.19
FROM python:3.11.9-slim
```

### 2. 镜像标签规范

```dockerfile
# 格式：项目名:版本-环境 
# 示例： 
# myapp:1.0.0-prod 
# backend:2.1.0-dev 
# frontend:3.0.0-beta
```
### 3. 多阶段构建

```dockerfile
# 第一阶段：构建阶段
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# 第二阶段：运行阶段
FROM node:18-alpine AS runtime
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
EXPOSE 3000
CMD ["node", "dist/index.js"]
```

### 4. 减少镜像层数

```dockerfile
# 合并RUN指令
RUN apt-get update && \
    apt-get install -y \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# 避免多个RUN指令
RUN apt-get update
RUN apt-get install -y curl
RUN apt-get install -y git
```

### 5. 文件复制优化

```dockerfile
# 先复制依赖文件，利用缓存
COPY package*.json ./
RUN npm install
COPY . .

#  避免：先复制所有文件
COPY . .
RUN npm install  # 每次代码变更都会重新安装依赖
```

### 6. 环境变量管理

```dockerfile
# 设置环境变量
ENV NODE_ENV=production
ENV PORT=3000

# 使用ARG构建时变量
ARG APP_VERSION
ENV APP_VERSION=${APP_VERSION}
```

### 7. 用户权限管理

```dockerfile
# 创建非root用户
RUN addgroup -g 1000 appuser && \
    adduser -u 1000 -G appuser -D appuser

# 切换用户
USER appuser

# 设置工作目录
WORKDIR /app
```

## **容器运行规范**

### 1. 容器命名规范

```bash
# 格式：项目名-服务名-环境-序号
docker run --name myapp-web-prod-1
docker run --name backend-api-dev-2
```

### 2. 资源限制

```bash
# 内存限制
docker run -d --memory=512m --memory-swap=1g nginx

# CPU限制
docker run -d --cpus="1.5" nginx

# CPU优先级
docker run -d --cpu-shares=512 nginx

# 重启策略
docker run -d --restart=always nginx
```

### 3. 网络配置

```bash
# 使用自定义网络
docker network create mynetwork
docker run -d --network=mynetwork nginx

# 端口映射
docker run -d -p 80:80 -p 443:443 nginx

# 主机名和域名
docker run -d --hostname=web --domainname=example.com nginx
```

### 4. 数据持久化

```bash
# 命名卷
docker volume create app-data
docker run -d -v app-data:/data nginx

# 绑定挂载
docker run -d -v /host/data:/data nginx

# 只读挂载
docker run -d -v /host/config:/config:ro nginx
```

## **安全注意事项**

### 1. 避免使用特权模式

```bash
# 危险：特权模式
docker run --privileged nginx

# 最小权限原则
docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE nginx
```

### 2. 用户权限

```bash
# 使用非root用户运行
docker run -u 1000:1000 nginx

# 设置只读文件系统
docker run --read-only nginx
```

### 3. 环境变量安全

```bash
# 避免在Dockerfile中硬编码敏感信息
# 不推荐
ENV DB_PASSWORD=123456

# 使用运行时注入
docker run -e DB_PASSWORD=secret nginx
```

### 4. 镜像扫描

```bash
# 使用安全扫描工具
docker scan nginx:alpine

# 定期更新基础镜像
docker pull nginx:alpine
```

## **最佳实践**

### 1. 镜像标签管理

```bash
# 推送镜像到仓库
docker tag myapp:latest registry.example.com/myapp:1.0.0
docker push registry.example.com/myapp:1.0.0

# 删除无用镜像
docker image prune -a
```

### 2. 容器日志管理

```bash
# 查看容器日志
docker logs -f container_name

# 日志驱动配置
docker run --log-driver=json-file --log-opt max-size=10m nginx

# 清理日志
docker container prune
docker volume prune
```

### 3. 健康检查

```dockerfile
# Dockerfile中添加健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1
```

### 4. 容器编排

```bash
# 使用Docker Compose
version: '3.8'
services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
```

##  **常见问题与解决方案**

### 问题1：镜像构建慢

**原因**：未合理利用缓存

**解决方案**：

```dockerfile
# 将不经常变更的文件放在前面
COPY package*.json ./
RUN npm install
COPY . .
```

### 问题2：容器权限不足

**原因**：使用root用户

**解决方案**：

```dockerfile
# 创建非root用户
RUN adduser -D appuser
USER appuser
```

### 问题3：容器无法访问网络

**原因**：网络配置错误

**解决方案**：

```bash
# 检查网络
docker network ls
docker network inspect bridge

# 使用自定义网络
docker network create mynetwork
docker run --network=mynetwork nginx
```

### 问题4：数据丢失

**原因**：未使用数据卷

**解决方案**：

```bash
# 使用命名卷
docker volume create app-data
docker run -v app-data:/data nginx

# 或绑定挂载
docker run -v /host/data:/data nginx
```

## **监控与维护**

### 1. 容器状态监控

```bash
# 查看容器状态
docker ps -a
docker stats

# 查看资源使用
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"

# 查看容器详情
docker inspect container_name
```

### 2. 日志管理

```bash
# 实时查看日志
docker logs -f container_name

# 查看最近100行日志
docker logs --tail=100 container_name

# 查看指定时间段的日志
docker logs --since="2023-01-01" container_name
```

### 3. 资源清理

```bash
# 清理停止的容器
docker container prune

# 清理无用镜像
docker image prune -a

# 清理无用网络
docker network prune

# 清理无用卷
docker volume prune
```

## **总结**

| 类别  | 推荐做法 | 避免做法 |
| --- | --- | --- |
| **镜像构建**​ | 多阶段构建、固定版本标签 | 使用latest标签、root用户 |
| **容器运行**​ | 资源限制、非特权模式 | 特权模式、无资源限制 |
| **数据管理**​ | 使用数据卷、命名卷 | 容器内存储数据 |
| **安全**​ | 最小权限、环境变量注入 | 硬编码敏感信息 |
| **网络**​ | 自定义网络、端口映射 | 使用默认bridge网络 |
| **监控**​ | 健康检查、日志驱动 | 无监控、无日志 |
