# 一、基础


## 1.1 基础

### 1.1.1 Docker是什么

用一个比喻来理解，想象一下，在物流行业：

- 传统运输：把形状各异的货物（你的应用）直接塞进货船（服务器），需要复杂的绑带、垫料（环境配置），而且货物之间会相互碰撞、依赖，一个出问题，可能影响全部。
- 集装箱运输：把所有货物及其内部环境（如保鲜、防震装置）一起打包进一个标准的集装箱里。这个集装箱可以在任何货船、卡车、港口上被运输和运行，完全不受外界环境影响。

Docker 就是这个“软件行业的集装箱”。
    
它是一个开源的应用容器引擎，允许开发者将其应用以及应用的所有依赖（如代码、运行时环境、系统工具、系统库）打包成一个标准化、轻量级、可移植的容器。这个容器可以在任何安装了 Docker 的机器上以完全相同的方式运行。

### 1.2 Docker 的核心概念


1. 镜像（Image）
    - 是什么：一个只读的模板，类似于面向对象编程中的“类”。它包含了运行应用所需的文件系统结构和运行参数。
    - 作用：镜像是用来创建容器的基石。它定义了一个静态的、不可变的环境。
    - 类比：镜像就像是集装箱的设计蓝图，或者是一个.iso系统安装光盘。
2. 容器（Container）
    - 是什么：镜像的一个运行实例。类似于由“类”创建出来的“对象”。容器是一个隔离的进程，拥有自己的文件系统、网络和进程空间。
    - 作用：容器是真正运行应用的地方。它是从镜像创建出来的，是可读可写的。
    - 类比：容器就是根据蓝图（镜像）​ 制造出来并投入使用的真正的集装箱。
3. 仓库（Registry）
    - 是什么：一个集中存储和分发镜像的地方。
    - 最著名的仓库：Docker Hub，就像 GitHub 对于代码一样，它是一个公共的镜像仓库，你可以从中拉取（下载）各种官方或社区制作的镜像（如 Nginx, MySQL, Redis 等），也可以推送（上传）自己构建的镜像。
    - 类比：仓库就像是集装箱的港口或货运中心，负责集装箱的存放和转运。

### 1.3 Docker的架构

1. 架构流程图

    ![](/operations/container/docker/001.png)

2. 图中的各个组件：
    1. Docker Client（客户端）
    
        这是用户与 Docker 交互的主要方式。当你使用 docker run, docker pull等命令时，你就是在调用 Docker 客户端。
        
        客户端通过 REST API 将命令发送给 Docker Daemon。
    2. Docker Daemon（守护进程）
        
        这是 Docker 架构的大脑，一个常驻在后台的系统进程（dockerd）。
        
        它负责监听并处理 Docker API 请求，来管理镜像、容器、网络和存储卷等核心对象。
    3. Docker Registry（镜像仓库）
        
        用于存储和分发 Docker 镜像的地方。
        
        Docker Hub​ 是默认的公共仓库，任何人都可以从上面拉取镜像。你也可以搭建私有的 Registry（如 Harbor）。
    4. Docker Objects（Docker 对象）
        
        这是 Docker 管理的核心实体，主要包括：
        
        - Images（镜像）
            
            一个只读的模板，包含了运行应用所需的文件系统（代码、库、依赖、配置）。
            
            镜像是分层构建的，每一层代表 Dockerfile 中的一条指令。这种分层结构使得镜像非常轻量和高效。
        - Containers（容器）
            
            镜像的一个运行实例。容器与镜像的关系，类似于面向对象中对象与类的关系。
            
            当容器启动时，Docker 会在镜像的只读层之上创建一个可写的容器层。所有对运行中容器的修改都发生在这个可写层，不会影响原始的镜像。

3. 工作流程剖析
    
    让我们通过一个 docker run -d nginx:latest命令，来看整个架构是如何协同工作的：
    
    1. 用户输入命令：你在终端输入 docker run -d nginx:latest。
    2. 客户端发送指令：Docker Client 将指令通过 REST API 发送给 Docker Daemon。
    3. Daemon 检查镜像：Docker Daemon 首先在本地查找是否存在 nginx:latest镜像。
    4. 拉取镜像（如需要）：如果本地没有，Daemon 会连接到配置的 Registry（默认 Docker Hub），拉取 nginx:latest镜像，并存储在本地的镜像存储中。
    5. 创建容器：Daemon 根据镜像创建一个新的容器。这个过程包括：
        - 为容器创建独立的 Network Namespace、PID Namespace 等。
        - 为容器创建 Cgroup，以便进行资源限制。
        - 基于镜像的只读层，创建一个可写的容器层。
    6. 运行容器：Daemon 告诉内核，在容器内运行指定的应用程序（例如 nginx进程）。
    7. 返回结果：Daemon 将容器的 ID 返回给 Client，Client 随即返回终端，你可以使用 docker ps看到这个正在运行的容器。

### 1.4 容器化

容器化的流程

![](/operations/container/docker/002.jpeg)


### 1.5 安装docker

1. 官方的安装地址

    [https://docs.docker.com/engine/install/centos/](https://docs.docker.com/engine/install/centos/)

2. 记录命令

    ```shell
    # 移除旧版本docker
    sudo yum remove docker \
                    docker-client \
                    docker-client-latest \
                    docker-common \
                    docker-latest \
                    docker-latest-logrotate \
                    docker-logrotate \
                    docker-engine

    # 配置docker yum源。
    sudo yum install -y yum-utils
    sudo yum-config-manager \
    --add-repo \
    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo


    # 安装 最新 docker
    sudo yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    # 启动& 开机启动docker； enable + start 二合一
    systemctl enable docker --now
    ```

3.  配置加速

    ```sh
     # 配置加速
    sudo mkdir -p /etc/docker
    sudo tee /etc/docker/daemon.json <<-'EOF'
    {
        "registry-mirrors": ["https://82m9ar63.mirror.aliyuncs.com"]
    }
    EOF
    sudo systemctl daemon-reload
    sudo systemctl restart docker
    ```
    
    `registry-mirrors` 各家云服务器厂商并不相同,请在云服务器中找这个地址

4. docker远程代理

    [https://hub.docker.com/] 这个网站需要联网，本地服务器是访问不到的，如果想要访问可参考[shadowsocks客户端连接docker配置](/markdown/network/external/shadowsocks/02.html) 

## 1.2 命令

### 1.2.1 镜像拉取删除

1. 进入镜像网站

    - 官方网站：[hub.docker.com](https://hub.docker.com/)

2. 镜像命令

    1. 搜索镜像

        - 执行命令

            ```sh
            docker search nginx
            ```

            ![](/operations/container/docker/003.png)

        - 查找网站

            ![](/operations/container/docker/004.png)

    2. 下载镜像

        ```sh
        #下载镜像
        docker pull nginx
        #下载指定版本镜像
        docker pull nginx:1.26.0
        ```
        >默认下载latest版本，如果需要其他版本去网站找对应版本


    3. 操作镜像

        ```sh
        #查看所有镜像 
        docker images
        #删除指定id的镜像
        docker rmi e784f4560448
        ```

### 1.2.2 容器操作

1. 基础命令

    ```sh
    #查看运行中的容器
    docker ps
    #查看所有容器
    docker ps -a
    #运行一个新容器
    docker run nginx
    #停止容器
    docker stop keen_blackwell
    #启动容器 592是端口号的缩写
    docker start 592
    #重启容器
    docker restart 592
    #查看容器资源占用情况
    docker stats 592
    #查看容器日志
    docker logs 592
    #删除指定容器
    docker rm 592
    #强制删除指定容器
    docker rm -f 592
    ```

2. run启动细节

    - 启动命令

        ```sh
        查询参数
        docker run -help
        # 后台启动容器
        docker run -d --name mynginx nginx
        # 后台启动并暴露端口
        docker run -d --name mynginx -p 80:80 nginx
        ```
    - 运行效果    
        - `-d`: 后台运行
        - `--name`: 容器名称
        - `-p 80:80`: 端口映射，内部端口80端口映射到外部的88端口（第一个参数是外部端口，第二个是内部端口）
    - 外部访问

        ![](/operations/container/docker/007.png)
3. 进入docker内部修改nginx

    - 进入容器

        ```sh
        # 进入容器内部
        docker exec -it mynginx /bin/bash
        ```

        - `exec`：进入docker
        - `-it`: 以交互模式进入
        - `/bin/bash`: 交互使用方式

        > docker内部也是linux系统，不过比较纯净，没有插件

        ![](/operations/container/docker/005.png)

    - 修改nginx文件

        ```sh
        # 查看nginx位置
        whereis nginx
        # 进入网页目录
        /usr/share/nginx/html
        # 修改输出内容（docker没有vim）
        echo "<h1>Hello,Docker</h1>" > index.html
        # 查看修改内容
        cat index.html
        # 退出交互模式
        exit
        ```
    - 运行结果

        ![](/operations/container/docker/008.png)

### 1.2.3 镜像打包推送

1. 保存镜像

    ```sh
    # 查看帮助类型
    docker commit -help
    # 提交容器变化打成一个新的镜像
    docker commit -m "update index.html" mynginx mynginx:v1.0
    # 保存镜像为指定文件
    docker save -o mynginx.tar mynginx:v1.0
    # 查看镜像文件
    docker images
    # 删除多个镜像
    docker rmi bde7d154a67f 94543a6c1aef e784f4560448
    # 加载镜像
    docker load -i mynginx.tar 
    # 启动
    docker run -d --name app01 -p 80:80 mynginx:v1.0
    ```

    ![](/operations/container/docker/009.png)

2. 分享镜像

    - 注册账户并登录

        ![](/operations/container/docker/010.png)
    - 服务器登录

        ```sh
        docker login -u <username>
        ```

        ![](/operations/container/docker/011.png)

    - 镜像推送

        - 推送命令

            ```sh
            # 重新给镜像打标签
            docker tag mynginx:v1.0 zhaofarmer/mynginx:v1.0
            # 查看是否成功
            docker images
            # 推送镜像
            docker push zhaofarmer/mynginx:v1.0
            ```
        - 推送结果
            
            ![](/operations/container/docker/012.png)
        - 网页查看

            ![](/operations/container/docker/013.png)
        - 编写文档

            ![](/operations/container/docker/014.png)
    - 再次推送

        - 推送命令

            ```sh
            docker tag mynginx:v1.0 zhaofarmer/mynginx:lastst
            ```
        - 页面结果

            ![](/operations/container/docker/015.png)

### 1.2.4 快速删除docker容器

1. 命令

    ```sh
    # 查询所有dockerId
    docker ps -aq
    # 删除运行的docker
    docker rm -f $(docker ps -aq)
    ```
2. 操作将结果

    ![](/operations/container/docker/016.png)


## 1.3 存储

### 1.3.1 目录挂载

1. 命令启动与挂载

    ```sh
    docker run -d -p 80:80 -v /app/nghtml:/usr/share/nginx/html --name app01 nginx
    ```

    > 映射的目录会自动创建文件夹
2. 页面访问

    ![](/operations/container/docker/017.png)

    >原因：/usr/share/nginx/html 目录下的内容放到主机硬盘下，但是主机硬盘下并没有文件

3. 新建index.html

    ```html
    cd /app/nghtml
    echo 6666 > index.html
    ```

    ![](/operations/container/docker/018.png)

4. 注意点

    1. 其他挂载映射这个目录，也会显示这个结果

        ```sh
        # 删除容器
        docker rm -f $(docker ps -aq)
        # 再次挂载
        docker run -d -p 80:80 -v /app/nghtml:/usr/share/nginx/html --name app01 nginx
        ```

    2. 在容器内部修改这个文件，外部也会发生改变

        ```sh
        # 进入容器内部
        docker ps
        docker exec -it f9a bash
        # 追加文字
        cd /usr/share/nginx/html
        echo 3333 >> index.html
        exit
        # 查看外部结果
        cat /app/nghtml/index.html
        ```

        ![](/operations/container/docker/019.png)

### 1.3.2 卷映射

1. 挂载的问题：挂载配置文件回出错

    - 启动命令

        ```sh
        # 启动容器挂载配置文件
        docker run -d -p 88:80 \
        -v /app/nghtml:/usr/share/nginx/html \
        -v /app/ngconf:/etc/nginx \
        --name app02 \
        nginx
        ```
    
    - 查看状态

        ```
        # 查看状态
        docker ps -a
        # 查看日志
        docker logs app02
        ```

        ![](/operations/container/docker/020.png)

2. 使用卷映射

    - 启动命令

        ```sh
        docker run -d -p 99:80 \
        -v /app/nghtml:/usr/share/nginx/html \
        -v ngconf:/etc/nginx \
        --name app03 \
        nginx
        ```
    - 所有映射文件都放在 `/var/lib/docker/volumes/<volume-name>`

        ```sh
        # 进入目录
        cd /var/lib/docker/volumes
        # 进入目录
        ls
        cd ngconf/_data/
        ``` 
    - 修改文件

        ```sh
        vim nginx.conf 
        exit
        ```
        ![](/operations/container/docker/021.png)
    - 外部查看

        ```sh
        # 进入容器内部
        docker exec -it app03 bash
        # 进入卷映射原目录
        cd /etc/nginx
        # 查看配置文件
        cat nginx.conf
        # 退出
        exit
        ```
3. 卷操作

    ```sh
    # 查看卷
    docker volume ls
    # 创建卷
    docker volume create haha
    # 查看卷的详情
    docker volume inspect ngconf
    ```

    ![](/operations/container/docker/022.png)

## 1.4 网络

- 网络图

    ![](/operations/container/docker/030.png)


### 1.4.1 基础网络

1. 准备工作

    ```sh
    # 清理容器
    docker rm -f $(docker ps -aq)
    # 创建容器app01
    docker run -d -p 88:80 --name app01 nginx
    # 创建容器app02
    docker run -d -p 99:80 --name app02 nginx
    # 查询容器
    docker ps
    ```
2. 容器 app01 访问 app02

    - 服务器地址福祥访问

        ```sh
        # 进入app01
        docker exec -it app01 bash
        # 通过服务器地址访问
        curl http://192.168.18.80:99
        # 退出
        exit
        ```

        ![](/operations/container/docker/025.png)

    - 服务器详情

        ```sh
        # 查看容器详情 可简写docker inspect
        docker container inspect app01
        docker container inspect app02
        ```

        ![](/operations/container/docker/023.png)

        ![](/operations/container/docker/024.png)

    - 使用内部网络访问

        ```sh
        # 进入app01
        docker exec -it app01 bash
        # 通过内部网络访问
        curl http://172.17.0.3:80
        # 退出
        exit
        ```

        ![](/operations/container/docker/026.png)

3. 总结：

    
    docker为每个容器分配唯一ip，使用 容器ip+容器端口 可以互相访问

    >回出现的问题：ip由于各种原因可能会变化
### 1.4.2 自定义网络

1. 使用自定义网络的原因：

    - docker0默认不支持主机域名
    - 创建自定义网络，容器名就是稳定域名

2. 创建网络

    ```sh
    # 帮助文档
    docker networrk --help
    # 创建网络
    docker network create mynet
    # 查看创建的网络
    docker networrk ls
    ```

    ![](/operations/container/docker/027.png)

3. 容器加入网络

    
    ```sh
    # 清理容器
    docker rm -f $(docker ps -aq)
    # 创建容器app01
    docker run -d -p 88:80 --name app01 --network mynet nginx
    # 创建容器app02
    docker run -d -p 99:80 --name app02 --network mynet nginx
    # 查询网络
    docker inspect app01
    ```

    ![](/operations/container/docker/028.png)

4. 直接通过容器名访问

    ```sh
    # 进入app01
    docker exec -it app01 bash
    # 通过内部网络访问
    curl http://app02:80
    # 退出
    exit
    ```
    ![](/operations/container/docker/029.png)

### 1.4.3 redis主从集群

1. 找到 bitnami/redis容器,并下载

    ![](/operations/container/docker/031.png)

    ```sh
    docker pull bitnami/redis:latest
    ```
2. redis 主从同步的架构

    ![](/operations/container/docker/032.png)

    > redis的参数都可以在 [https://hub.docker.com/r/bitnami/redis](https://hub.docker.com/r/bitnami/redis) 查询到

    ![](/operations/container/docker/033.png)

3. 启动集群

    1. 启动同步集群-主机

        ```sh
        # 创建容器
        docker run -d -p 6379:6379 \
        -v /app/rd1:/bitnami/redis/data \
        -e REDIS_REPLICATION_MODE=master \
        -e REDIS_PASSWORD=123456 \
        --network mynet --name redis01 \
        bitnami/redis
        # 检查容器(启动失败)
        docker ps -a
        # 查看日志(日志中的信息表示没有权限)
        docker logs redis01
        # 进入app
        cd /app
        # 修改权限
        chmod 777 rd1
        # 重启docker容器
        docker restart redis01.
        # 检查容器(启动成功)
        docker ps -a
        ```
    2. 启动从机

        ```sh
        # 进入app
        cd /app
        # 创建持久化目录
        mkdir rd2
        # 修改权限
        chmod 777 rd2
        # 创建容器 redis02
        docker run -d -p 6380:6379 \
        -v /app/rd2:/bitnami/redis/data \
        -e REDIS_REPLICATION_MODE=slave \
        -e REDIS_MASTER_HOST=redis01 \
        -e REDIS_MASTER_PORT_NUMBER=6379 \
        -e REDIS_MASTER_PASSWORD=123456 \
        -e REDIS_PASSWORD=123456 \
        --network mynet --name redis02 \
        bitnami/redis
        # 查看是否成功
        docker ps
        ```

4. 打开桌面端工具，新增数据是否主从同步

    ![](/operations/container/docker/034.png)

### 1.4.4 部署mysql

1. 找到 mysql镜像,并下载

    - 选择mysql
        
        ![](/operations/container/docker/035.png)
    - 只用这个镜像

        ![](/operations/container/docker/037.png)
2. 命令运行

    ```sh
    # 直接运行镜像，如果本地存在镜像，会直接下载
    docker run -d -p 3306:3306 \
    -v /app/myconf:/etc/mysql/conf.d \
    -v /app/mydata:/var/lib/mysql \
    -e MYSQL_ROOT_PASSWORD=123456 \
    mysql:8.0.44-debian
    ```
3. 远程连接后，进行数据

    ![](/operations/container/docker/038.png)

## 1.5 最佳实践

1. docker容器包含三大部分
    1. 网络
    2. 存储
    3. 环境变量

2. 架构图

    ![](/operations/container/docker/036.png)