# 三、新版本shadowsocks-rust

## 3.1 客户端（Rocky Linux）

1. shadowsocks-rust: 

    [https://github.com/shadowsocks/shadowsocks-rust/releases](https://github.com/shadowsocks/shadowsocks-rust/releases)

2. 选择linux版本类型x86

    ![](/network/external/shadowsocks/010.png)

3. 安装并启动

    - 操作命令

        ```sh
        # 解压文件
        tar -xf shadowsocks-v1.23.5.x86_64-unknown-linux-gnu.tar.xz 
        # 文件放到固定目录
        mkdir /usr/shadowsocks-client/
        mv sslocal /usr/shadowsocks-client/
        cd /usr/shadowsocks-client/
        # 配置文件
        vim config.json
        ```

    - 配置文件 config.json 

        ```json
        {
            "server": "my_server_ip",
            "server_port": 9919,
            "password": "rwQc8qPXVsRpGx3uW+Y3Lj4Y42yF9Bs0xg1pmx8/+bo=",
            "method": "aes-256-gcm",
            "local_address": "127.0.0.1",
            "local_port": 1080
        }
        ```

    - 临时启动

        ```sh
        # 启动程序
        ./sslocal -c config.json
        ```
    - 后台启动

        ```sh
        nohup ./sslocal -c config.json > /dev/null 2>&1 &
        ```

4. 创建systemd服务(永久启动)

    - 创建服务文件

        ```bash
        sudo vim /etc/systemd/system/shadowsocks.service
        ```

    - 添加以下内容

        ```ini
        [Unit]
        Description=Shadowsocks Client
        After=network.target

        [Service]
        Type=simple
        User=root
        ExecStart=/usr/shadowsocks-client/sslocal -c /usr/shadowsocks-client/config.json
        Restart=always
        RestartSec=3

        [Install]
        WantedBy=multi-user.target
        ```

    - 启动并设置开机自启

        ```bash
        # 重新加载systemd配置
        sudo systemctl daemon-reload
        # 启动服务
        sudo systemctl start shadowsocks
        # 查看服务状态
        sudo systemctl status shadowsocks
        # 设置开机自启
        sudo systemctl enable shadowsocks
        ```
    - 如果启动失败，大概率SELinux问题

        ```sh
        # 临时禁用 SELinux 测试
        sudo setenforce 0
        sudo systemctl daemon-reload
        sudo systemctl restart shadowsocks
        sudo systemctl status shadowsocks

        # 如果成功，说明是 SELinux 问题
        # 临时解决方案：给文件打标签
        sudo chcon -t bin_t /usr/shadowsocks-client/sslocal
        sudo chcon -t bin_t /usr/shadowsocks-client/config.json
        sudo setenforce 1
        sudo systemctl restart shadowsocks
        ```

5. 使用 privoxy

    直接使用sslocal是不能转发HTTP和HTTPS的流量的，还需要安装privoxy

    1. 安装并启动

        ```sh
        # 安装插件
        sudo yum -y install epel-release
        sudo yum -y install privoxy
        # 配置 socks5 全局代理
        echo 'forward-socks5 / 127.0.0.1:1080 .' >> /etc/privoxy/config
        # 运行 privoxy
        sudo service privoxy start
        # 检查装填
        sudo systemctl status privoxy
        # 设置开机启动
        sudo systemctl enable privoxy
        #  验证是否已启用
        sudo systemctl is-enabled privoxy
        ```
    2. 测试privoxy

        1. 使用 curl 测试

            ```sh
            curl -I --proxy http://127.0.0.1:8118 http://www.google.com
            ```
        2. 使用环境变量测试

            ```sh
            export http_proxy=http://127.0.0.1:8118
            export https_proxy=http://127.0.0.1:8118
            curl -I http://www.google.com
            ```
    3. 配置系统级代理

        > 配置后也只是把访问 `web` 连接进行代理，需要上外网的软件的代理都放到它自己的配置文件中，所以如果使用linux服务器办公完全可以不用配置。

        1. 为所有用户设置环境变量(需要重启)

            - 编辑 `/etc/environment`：

                ```bash
                sudo vim /etc/environment
                ```
            - 添加：

                ```ini
                http_proxy="http://127.0.0.1:8118"
                https_proxy="http://127.0.0.1:8118"
                ftp_proxy="http://127.0.0.1:8118"
                no_proxy="localhost,127.0.0.1,::1"
                ```
        2. 为当前用户设置

            编辑 `~/.bashrc`或 `~/.bash_profile`：

            ```bash
            echo 'export http_proxy=http://127.0.0.1:8118' >> ~/.bashrc
            echo 'export https_proxy=http://127.0.0.1:8118' >> ~/.bashrc
            echo 'export no_proxy="localhost,127.0.0.1"' >> ~/.bashrc
            source ~/.bashrc
            ```

6. 示例：配合privoxy完成docker代理

    1.  修改配置文件：

        ```bash
        # 为Docker服务创建 systemd 配置目录
        sudo mkdir -p /etc/systemd/system/docker.service.d
        # 创建或编辑代理配置文件
        sudo vim /etc/systemd/system/docker.service.d/http-proxy.conf
        ```
    2. 配置文件

        ```sh
        [Service]
        Environment="HTTP_PROXY=http://127.0.0.1:8118"
        Environment="HTTPS_PROXY=http://127.0.0.1:8118"
        Environment="NO_PROXY=localhost,127.0.0.1,registry.access.redhat.com,registry.docker-cn.com"
        ```
    3. 重新加载并重启 Docker

        ```sh
        sudo systemctl daemon-reload
        sudo systemctl restart docker
        ```
## 3.2 服务端（Rocky Linux）

1. 下载文件

    目前只有rust还在更新，这里安装shadowsocks-rust

    进入[https://github.com/shadowsocks/shadowsocks-rust/releases](https://github.com/shadowsocks/shadowsocks-rust/releases)

    ![](/network/external/shadowsocks/010.png)

2. 上传文件

    ```sh
    # 打开云服务器，使用rz命令上传
    rz
    # 解压文件
    tar -xf shadowsocks-v1.23.5.x86_64-unknown-linux-gnu.tar.xz
    # 创建文件夹
    sudo mkdir -p /usr/shadowsocks-server/
    # 移动文件
    mv ssserver /usr/shadowsocks-server/
    ```

    ![](/network/external/shadowsocks/011.png)


3. 创建配置文件

    创建一个 JSON 格式的配置文件 /usr/shadowsocks-server/config.json，定义服务器的监听地址、端口、密码和加密方法。 

    ```sh
    sudo vim /usr/shadowsocks-server/config.json
    ```

    将以下内容粘贴到文件中，并修改 server_port、password 和 method：

    ```json
    {
        "server":"0.0.0.0",
        "server_port":9919,
        "password":"your_strong_password",
        "method":"chacha20-ietf-poly1305",
        "timeout":300,
        "mode":"tcp_and_udp"
    }
    ```
        
4. 配置 systemd 服务

    创建一个 systemd 服务单元文件。

    ```sh
    sudo vim /etc/systemd/system/shadowsocks-server.service
    ```

    粘贴以下内容到文件中：

    ```ini
    [Unit]
    Description=Shadowsocks Rust Server Service
    After=network-online.target

    [Service]
    Type=simple
    ExecStart=/usr/bin/ssserver -c /usr/shadowsocks-server/config.json

    [Install]
    WantedBy=multi-user.target
    ```


5. 启动并启用服务
    
    重新加载 systemd 配置，启用服务并启动它。 

    ```sh
    # 刷新服务
    sudo systemctl daemon-reload
    # 注册服务
    sudo systemctl enable shadowsocks-server.service
    # 启动服务
    sudo systemctl start shadowsocks-server.service
    # 查看服务状态
    systemctl status shadowsocks-server.service
    ```

6. 添加通过端口

    ![](/network/external/shadowsocks/012.png)

7. 访问结果

    ![](/network/external/shadowsocks/013.png)

