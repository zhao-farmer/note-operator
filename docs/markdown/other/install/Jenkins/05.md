# 五、构建各种类型的项目

## 5.1 构建 express + react

### 5.1.1 文件构建后传入目标服务器

1. `jenkins`安装node插件

	在 Jenkins 管理后台 → 插件管理中，安装 NodeJS 插件，用于提供 Node.js 和 npm 环境。

	![](/other/install/jenkins/171.png)

	![](/other/install/jenkins/172.png)

2. `服务器`安装node环境

    ```sh
	# 获取node文件
    wget https://nodejs.org/dist/v24.12.0/node-v24.12.0-linux-x64.tar.xz
	# 解压文件 -xJf：x 解压，J 表示 .xz 格式，f 指定文件
	tar -xJf node-v24.12.0-linux-x64.tar.xz
	# 移动到指定目录
	mv node-v24.12.0-linux-x64 /opt/nodejs
	# 配置环境变量
	echo 'export PATH="/opt/nodejs/bin:$PATH"' >> ~/.bashrc
	source ~/.bashrc
	# 查询安装结果
	node -v
	npm -v
	# 安装pnpm（速度会更快，且有缓存）
	npm install -g pnpm
	pnpm -v
	# 配置代理
	npm config set registry https://registry.npmmirror.com/
    ```

3. jenkins配置node环境

	在 Jenkins 管理后台 → 全局工具配置中，选择安装的node路径

	![](/other/install/jenkins/173.png)

	![](/other/install/jenkins/174.png)
4. 创建流水线项目

	![](/other/install/jenkins/175.png)

	![](/other/install/jenkins/176.png)

5. 脚本文件

	```groovy
	pipeline {
		agent any
		tools {
			nodejs 'node24'
		}
		stages {
			stage('git code') {
				steps {
					git branch: 'main', credentialsId: 'gitlab', url: 'http://192.168.18.81/root/pinterest.git'
					echo "拉取代码"
				}
			}
		
			stage('Install && build') {
				steps {
					sh '''
						cd client
						pnpm install 
						pnpm run build
					''' 
					echo "前端安装插件并打包"
				}
			}
			stage('send files to docker-Server') {
				steps {
				sshPublisher(
						publishers: [
							sshPublisherDesc(
								configName: 'Test-Server-Docker',
								transfers: [
									sshTransfer(
										cleanRemote: false,
										excludes: '',
										execCommand: '',
										execTimeout: 120000,
										flatten: false,
										makeEmptyDirs: false,
										noDefaultExcludes: false,
										patternSeparator: '[, ]+',
										remoteDirectory: '/pinterest/client',
										remoteDirectorySDF: false,
										removePrefix: 'client/dist',       // 注意：通常不以 '/' 开头
										sourceFiles: 'client/dist/**' // 修正拼写：clinet → client；建议使用通配符
									)
								],
								usePromotionTimestamp: false,
								useWorkspaceInPromotion: false,
								verbose: false
							),
							sshPublisherDesc(
								configName: 'Test-Server-Docker',
								transfers: [
									sshTransfer(
										cleanAssistant: false,
										excludes: '',
										execCommand: '',
										execTimeout: 120000,
										flatten: false,
										makeEmptyDirs: false,
										noDefaultExcludes: false,
										patternSeparator: '[, ]+',
										remoteDirectory: '/pinterest/server',
										remoteDirectorySDF: false,
										removePrefix: 'backend',
										sourceFiles: 'backend/**'   // 建议使用通配符确保递归上传
									)
								],
								usePromotionTimestamp: false,
								useWorkspaceInPromotion: false,
								verbose: false
							)
						]
					)
					echo "将文件发送到docker服务器上"
				}
			}
		
		}
		post {
			success {
				echo '项目已发送到服务器！'
			}
		}
	}
	```

6. 目标服务器查看结果

	![](/other/install/jenkins/177.png)

### 5.1.2 配置dockerFile打成镜像

1. 使用docker拉取镜像

	>使用dockerfile会失败，这里先下载

	```sh
	# 下载node镜像
	docker pull node:24-alpine
	# 下载nginx镜像
	docker pull nginx
	# 下载mysql镜像
	docker pull mysql:8.0
	```

2. 启动mysql容器

	```sh
	# 创建文件
	mkdir -p /opt/mysql/data
	```

	```dockerfile
    docker run -d -p 3306:3306 \
		-e MYSQL_ROOT_PASSWORD=123456 \
		-e MYSQL_DATABASE=pinterest \
		-v /opt/mysql/data:/var/lib/mysql \
		-v /opt/mysql/myconf:/etc/mysql/conf.d \
		--restart always --name mysql-db \
		mysql:8.0
	```
3. 开发环境的数据放到这个数据库


4. 在 /root/pinterest 创建 DockerFile 文件

	```DockerFile
	# 使用官方 Node.js 24.12 镜像
	FROM node:24-alpine AS base

	# 安装 Nginx 和 MySQL 客户端（用于调试或初始化脚本）
	RUN apk add --no-cache nginx mysql-client

	# 创建应用目录
	WORKDIR /app

	# 复制整个项目（假设构建上下文包含 pinterest/ 目录）
	COPY server ./pinterest/server
	COPY client ./pinterest/client

	# 安装后端依赖
	WORKDIR /app/pinterest/server
	RUN npm install 

	# 返回根目录
	WORKDIR /app

	# 配置 Nginx
	RUN mkdir -p /run/nginx
	COPY nginx.conf /etc/nginx/nginx.conf

	# 创建日志目录
	RUN mkdir -p /var/log/nginx

	# 暴露端口
	EXPOSE 80

	# 启动脚本
	COPY start.sh /app/pinterest/start.sh
	RUN chmod +x /app/pinterest/start.sh

	# 启动 Nginx 和 Node.js
	CMD ["/app/pinterest/start.sh"]
	```
5. 在 /root/pinterest 创建 nginx.conf 文件

	```ini
	events {
		worker_connections 1024;
	}

	http {
		include       /etc/nginx/mime.types;
		default_type  application/octet-stream;

		server {
			listen 80;
			server_name localhost;

			# 前端静态资源
			location / {
				root /app/pinterest/client;
				try_files $uri $uri/ /index.html;
			}

			# API 代理到 Express 后端
			location /api/ {
				proxy_pass http://127.0.0.1:3000/;
				proxy_http_version 1.1;
				proxy_set_header Upgrade $http_upgrade;
				proxy_set_header Connection 'upgrade';
				proxy_set_header Host $host;
				proxy_set_header X-Real-IP $remote_addr;
				proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_cache_bypass $http_upgrade;
			}
		}
	}

	```
6. 在 /root/pinterest 创建 start.sh 文件

	```sh
	#!/bin/sh
	set -e

	echo "Starting Nginx..."
	nginx

	echo "Starting Express server..."
	cd /app/pinterest/server
	exec npm run dev
	```

7. 构建并允许

	```sh
	# 构建镜像
	docker build -t pinterest-app .

	# 启动容器
	docker run -d \
        --name pinterest-container \
        --link mysql-db:mysql \
        -e DB_HOST=mysql \
        -e DB_USER=root \
        -e DB_PASS=123456 \
        -e DB_NAME=pinterest \
        -e PICTURE_LOCATION=/app/images \
        -v /var/local/images:/app/images \
        -p 80:80 \
        pinterest-app
	
	# 进入容器
	docker exec -it pinterest-container /bin/sh
	```

8. 页面查看

	![](/other/install/jenkins/178.png)

### 5.1.3 使用流水线构建

1. 在项目中新建三个文件

	![](/other/install/jenkins/179.png)

2. jenkins中的流水线脚本

	```groovy
	pipeline {
		agent any
		
		tools {
			nodejs 'node24'
		}
		
		stages {
			stage('拉取代码') {
				steps {
					git branch: 'main', credentialsId: 'gitlab', url: 'http://192.168.18.81/root/pinterest.git'
					echo " 代码拉取完成"
				}
			}
		
			stage('前端构建') {
				steps {
						sh '''
							cd client
							pnpm install
							pnpm run build
						'''
					echo " 前端构建完成"
				}
			}
			
			stage('清理旧部署') {
				steps {
					sshPublisher(publishers: [
						sshPublisherDesc(
							configName: 'Test-Server-Docker', 
							transfers: [
								sshTransfer(
									execCommand: '''
										# 清理目录
										cd /root/pinterest && rm -rf ./* 2>/dev/null || true
										
										# 清理容器
										docker stop pinterest-container 2>/dev/null || true
										docker rm pinterest-container 2>/dev/null || true
										
										# 清理镜像
										docker rmi pinterest-app 2>/dev/null || true
									''', 
									execTimeout: 120000,
									sourceFiles: ''
								)
							]
						)
					])
					echo " 旧部署清理完成"
				}
			}
			
			stage('传输文件到服务器') {
				steps {
					sshPublisher(publishers: [
						sshPublisherDesc(
							configName: 'Test-Server-Docker',
							transfers: [
								sshTransfer(
									remoteDirectory: 'pinterest/client',
									removePrefix: 'client/dist',
									sourceFiles: 'client/dist/**',
									execTimeout: 120000
								),
								sshTransfer(
									remoteDirectory: 'pinterest/server',
									removePrefix: 'backend',
									sourceFiles: 'backend/**',
									execTimeout: 120000
								),
								sshTransfer(
									remoteDirectory: 'pinterest',
									removePrefix: 'docker',
									sourceFiles: 'docker/**',
									execTimeout: 120000
								)
							]
						)
					])
					echo " 文件传输完成"
				}
			}
			
			stage('构建镜像并启动') {
				steps {
				sshPublisher(publishers: [
					sshPublisherDesc(
						configName: 'Test-Server-Docker', 
						transfers: [
							sshTransfer(
								execCommand: '''
									# 切换到项目目录
									cd /root/pinterest
								
									# 构建镜像
									docker build -t pinterest-app .
									
									# 启动容器
									docker run -d \
										--name pinterest-container \
										--link mysql-db:mysql \
										-e DB_HOST=mysql \
										-e DB_USER=root \
										-e DB_PASS=123456 \
										-e DB_NAME=pinterest \
										-e PICTURE_LOCATION=/app/images \
										-v /var/local/images:/app/images \
										-p 80:80 \
										pinterest-app
								''', 
								execTimeout: 120000,
								sourceFiles: ''
							)
						]
					)
				])
				echo " 镜像构建启动完成"
			}
		}
	}
		
		post {
			success {
				echo ' 流水线执行成功！'
			}
			failure {
				echo ' 流水线执行失败！'
			}
		}
	}

	```

3. 脚本执行结果

	![](/other/install/jenkins/180.png)


### 5.1.4 镜像发布与云服务器允许

1. 打包到hub官网上

	```shell
	# docker 登录
	docker login -u zhaofarmer
	# 给当前镜像打标签
	docker tag pinterest-app:latest zhaofarmer/pinterest-app
	# 镜像提交
	docker push zhaofarmer/pinterest-app
	```
2. docker提示信息

	````
	# 镜像文件的使用

	## 1. 在目标服务器安装mysql8.0

	```shell
	# 创建文件
	mkdir -p /opt/mysql/data
	# 创建mysql8.0的镜像
	docker run -d -p 3306:3306 \
		-e MYSQL_ROOT_PASSWORD=123456 \
		-e MYSQL_DATABASE=pinterest \
		-v /opt/mysql/data:/var/lib/mysql \
		-v /opt/mysql/myconf:/etc/mysql/conf.d \
		--restart always --name mysql-db \
		mysql:8.0
	```
	## 2. 准备图片

	```txt
	/var/local/images/
	├── avatar/ 			# 头像文件夹
	│   ├── public/     		# 公共头像
	│   └── uploads/          	# 个人上传头像 (不填充数据)
	├── cache/ 			# 缓存数据  (不填充数据)
	├── uploads/             	# 展示图片的文件夹(每个文件夹后续都会生成一个用户)
	│   ├── imagesFiles1/     # 自己的文件夹1
	│   ├── imagesFiles2/     # 自己的文件夹2
	...
	```

	## 3. 拉取镜像并启动

	```shell
	# 拉取镜像
	docker pull zhaofarmer/pinterest-app
	# 启动镜像
	docker run -d \
		--name pinterest-container \
		--link mysql-db:mysql \
		-e DB_HOST=mysql \
		-e DB_USER=root \
		-e DB_PASS=123456 \
		-e DB_NAME=pinterest \
		-e PICTURE_LOCATION=/app/images \
		-v /var/local/images:/app/images \
		-p 80:80 \
		zhaofarmer/pinterest-app
	```

	## 4. 根据图片生成用户数据

	```shell
	# 进入容器内部
	docker exec -it pinterest-container /bin/sh
	# 进入服务端
	cd /app/pinterest/server
	# 生成数据
	npm run data
	```
	## 5. 通过服务器查看
	...
	````

3. 服务器按照步骤执行

	![](/other/install/jenkins/181.png)

4. 访问路径

5. 如果修改密码

	```sh
	# 1. 进入容器
	docker exec -it mysql-db mysql -p123456

	# 远程密码
	ALTER USER 'root'@'%' IDENTIFIED BY '新密码';
	# 本地密码
	ALTER USER 'root'@'localhost' IDENTIFIED BY '新密码';
	FLUSH PRIVILEGES;
	EXIT;
	```

## 5.2 构建NUXT4

### 5.2.1 项目配置

nuxt4 中环境变量是不会读取系统的，需要在打包的时候就放进去

```js{2}
"scripts": {
    "build": "nuxt build --dotenv .env.production",
    "dev": "nuxt dev --dotenv .env.local",
    "generate": "nuxt generate",
    "preview": "nuxt preview",
    "postinstall": "nuxt prepare",
    "deploy": "nuxt build"
},
```

### 5.2.2 jenkins配置

1. 创建流水线项目

	![](/other/install/jenkins/182.png)

2. 流水线脚本

	```groovy
	pipeline {
	    agent any
	
	    tools {
	        nodejs 'node24'
	    }
	
	    stages {
	        stage('拉取代码') {
	            steps {
	                git branch: 'main', credentialsId: 'gitlab', url: 'http://192.168.18.	81/root/jbook.git'
	                echo " 代码拉取完成"
	            }
	        }
	
	        stage('构建程序') {
	            steps {
	                    sh '''
	                        pnpm install
	                        pnpm run build
	                        tar -czf output.tar.gz .output/
	                        ls -lh output.tar.gz
	                    '''
	                echo "NUXT4构建完成"
	            }
	        }
	
	        stage('清理旧部署') {
	            steps {
	                sshPublisher(publishers: [
	                    sshPublisherDesc(
	                        configName: 'Test-Server-Docker', 
	                        transfers: [
	                            sshTransfer(
	                                execCommand: '''
	                                    # 清理目录
	                                    cd /root/jbook && rm -rf ./* 2>/dev/null || true
	
	                                    # 清理容器
	                                    docker stop jbook-container 2>/dev/null || true
	                                    docker rm jbook-container 2>/dev/null || true
	
	                                    # 清理镜像
	                                    docker rmi jbook-app 2>/dev/null || true
	                                ''', 
	                                execTimeout: 120000,
	                                sourceFiles: ''
	                            )
	                        ]
	                    )
	                ])
	                echo " 旧部署清理完成"
	            }
	        }
	
	        stage('传输文件到服务器') {
	            steps {
	                sshPublisher(publishers: [
	                    sshPublisherDesc(
	                        configName: 'Test-Server-Docker',
	                        transfers: [
	                            sshTransfer(
	                                remoteDirectory: 'jbook',
	                                removePrefix: '',
	                                sourceFiles: 'output.tar.gz',
	                                execTimeout: 240000
	                            ),
	                            sshTransfer(
	                                remoteDirectory: 'jbook',
	                                removePrefix: 'docker',
	                                sourceFiles: 'docker/**',
	                                execTimeout: 120000
	                            )
	                        ]
	                    )
	                ])
	                echo " 文件传输完成"
	            }
	        }
	
	        stage('构建镜像并启动') {
	        	steps {
				  sshPublisher(publishers: [
					sshPublisherDesc(
						configName: 'Test-Server-Docker', 
						transfers: [
							sshTransfer(
								execCommand: '''
									# 切换到项目目录
									cd /root/jbook

								    # 解压文件
								    tar -xzf output.tar.gz

									# 构建镜像
									docker build -t jbook-app .

									# 启动容器
	                                docker run -d \
	                                	--name jbook-container \
	                                	--link mysql-db:mysql \
	                                	-p 5002:3000 \
	                                	jbook-app
								''', 
								execTimeout: 240000,
								sourceFiles: ''
							)
						]
					)
				])
				echo " 镜像构建启动完成"
			}
		 }
	   }
	
	    post {
	        success {
	            echo ' 流水线执行成功！'
	        }
	        failure {
	            echo ' 流水线执行失败！'
	        }
	    }
	}
	```

3. 流水线脚本运行结果

	![](/other/install/jenkins/183.png)


