# 一、jenkins部署安装

**Jenkins** 是一个开源的自动化服务器，用于实现持续集成和持续交付（CI/CD），帮助团队自动化软件构建、测试和部署过程。

## 1.1 了解与准备

1. jenkins在开发过程中所属位置

  	![](/other/install/jenkins/001.png)

2. 准备服务器

	- **Jenkins-GitLab**：系统`Rocky Linux9`,内存6G,CPU2核,磁盘20G,IP`192.168.18.81`
	- **Jenkins-Server**：系统`Rocky Linux9`,内存2G,CPU2核,磁盘20G,IP`192.168.18.82`
	- **Jenkins-Test**：系统`Rocky Linux9`,内存4G,CPU4核,磁盘10G,IP`192.168.18.83`
	- **Jenkins-Docker**：系统`Rocky Linux9`,内存6G,CPU2核,磁盘20G,IP`192.168.18.84`

## 1.2 GitLab的安装使用

### 1.2.1 GitLab介绍及安装准备

GitLab 是一个完整的 DevOps 平台，从项目计划、源代码管理到 CI/CD、监控，全部在一个应用中完成。​ 它不只是 Git 仓库，而是一体化的软件开发平台。

官方网站: [https://about.gitlab.com/](https://about.gitlab.com/)
中文配置需求：[https://docs.gitlab.cn/docs/omnibus/installation/](https://docs.gitlab.cn/docs/omnibus/installation/)

> 这里只需要它的代码集成功能（也就是免费版本）

### 1.2.2 SHH下安装

官方安装文档: [https://docs.gitlab.com/install/package](https://docs.gitlab.com/install/package)

1. 安装依赖

	```sh
	sudo dnf install -y curl policycoreutils-python-utils openssh-server perl
	sudo systemctl enable sshd
	sudo systemctl start sshd
	```

2. 配置镜像

	```sh
	# 添加 GitLab 官方仓库
	curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash

	# 清华镜像源配置（官方仓库200kb/s,配置完成按照你的最大网络）
	sudo tee /etc/yum.repos.d/gitlab-ce.repo << 'EOF'
	[gitlab-ce]
	name=GitLab CE Repository
	baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/
	gpgcheck=0
	enabled=1
	EOF
	```
3. 开始安装

	```sh
	sudo EXTERNAL_URL="http://192.168.18.81" dnf install -y gitlab-ce
	```

4. 安装结果

	![](/other/install/jenkins/002.png)

	```sh
	cat /etc/gitlab/initial_root_password
	```

	>注意：除非您在安装过程中指定了自定义密码，否则将随机生成一个密码并存储在`/etc/gitlab/initial_root_password` 文件中(出于安全原因，24小时后，此文件会被第一次 `gitlab-ctlreconfigure` 自动删除，因此若使用随机密码登录，建议安装成功初始登录成功之后，立即修改初始密码)。使用此密码和用户名 root 登录。

	![](/other/install/jenkins/003.png)

5. gitlab设置中文

	- ‌**登录后进入偏好设置‌**‌：使用账户登录 GitLab，点击页面右上角的个人头像，选择“Settings”或“Preferences”（偏好设置）。‌
	- ‌**修改语言选项‌**‌：在设置页面中，找到“Localization”（本地化）或类似区域，将语言从默认“English”更改为“简体中文”。‌
	- ‌**保存并刷新页面‌**‌：完成修改后，点击“Save changes”或相应保存按钮。随后刷新浏览器页面，界面即显示为中文。 若未立即生效，可尝试退出账户重新登录。‌

	![](/other/install/jenkins/004.png)

### 1.2.3 Docker下安装

1. yum处理

	```sh
	# 更新yum
	yum update
	# 安装docker工具环境
	yum install -y yum-utils device-mapper-persistent-data lvm2
	```
2. 安装docker

	```sh
	# 查看源中可使用版本
	list docker-ce --showduplicates | sort -r
	# 安装指定版本
	yum install docker
	# 配置开机启动项
	systemctl start docker
	systemctl enable docker
	docker version
	```

3. 安装gitlab

	gitlab再docker上的地址：[https://hub.docker.com/r/gitlab/gitlab-ce](https://hub.docker.com/r/gitlab/gitlab-ce)


	1. 添加并运行GitLab容器

		```bash
		docker run --detach \
		  --hostname 192.168.18.84 \
		  --publish 5000:80  \
		  --name gitlab \
		  --restart always \
		  --volume /srv/gitlab/config:/etc/gitlab:z \
		  --volume /srv/gitlab/logs:/var/log/gitlab:z \
		  --volume /srv/gitlab/data:/var/opt/gitlab:z \
		  --shm-size 256m \
		  gitlab/gitlab-ce:latest
		```

		**中途失败或者已下载文件**

		```sh
		# 移除容器
		docker rm 914385c4d1fa
		# 重新启动
		docker run -d --name gitlab -p 5000:80 gitlab/gitlab-ce:latest
		```

	2. 容器操作

		```bash
		# 启动容器
		docker start gitlab
		# 查看容器装填
		docker ps
		```

	3. 寻找密码文件

		```bash
		# 进入容器
		docker exec -it gitlab /bin/bash
		cat /etc/gitlab/initial_root_password
		```

4. 外部登录

	![](/other/install/jenkins/005.png)

### 1.2.4 gitlab客户端提交代码

1. 创建项目

	![](/other/install/jenkins/006.png)

	![](/other/install/jenkins/007.png)

	![](/other/install/jenkins/008.png)

	![](/other/install/jenkins/009.png)

2. 配置SSH密钥

	![](/other/install/jenkins/012.png)

	```sh
	# 使用 git 获取SSH密钥
	ssh-keygen -t rsa -C GitHub账号邮箱
	cd .ssh/
	ll
	cat id_rsa.pub
	```

3. idea创建项目

	- 项目配置

		![](/other/install/jenkins/010.png)

		![](/other/install/jenkins/011.png)

	- 主要代码
		
		```java
		@Controller("/")
		@ResponseBody
		public class HelloController {

			@RequestMapping()
			public String hello() {
				return "Hello World" ;
			}
		}
		```

	- 运行结果

		![](/other/install/jenkins/021.png)

4. 提交代码

	- 安装插件

		![](/other/install/jenkins/014.png)
	- 添加个人访问令牌

		![](/other/install/jenkins/015.png)
	- 提交命令

		![](/other/install/jenkins/013.png)
	
4. 合并分支

	- 进入项目中 可以看到两个分支

		![](/other/install/jenkins/016.png)
	- 创建合并分支请求

		![](/other/install/jenkins/017.png)
	- 一些指标

		![](/other/install/jenkins/018.png)
	- 选择立即合并

		![](/other/install/jenkins/019.png)
	- 合并结果

		![](/other/install/jenkins/020.png)

## 1.3 jenkins安装使用

### 1.3.1 安装jdk

```bash
#  搜索可用的 JDK 包
dnf search java | grep jdk
# 安装 JDK 开发包
dnf install java-1.17.0-openjdk-devel
# 验证安装
java -version
```

### 1.3.2 安装maven

1. 寻找maven下载地址 [https://maven.apache.org/download.cgi](https://maven.apache.org/download.cgi)

	![](/other/install/jenkins/032.png)

	复制链接或者直接下载

2. 开始安装
	
	```sh
	# 1. 下载最新版Maven
	wget https://dlcdn.apache.org/maven/maven-3/3.9.11/binaries/apache-maven-3.9.11-bin.tar.gz

	# 2. 解压到/opt目录
	sudo tar -zxvf apache-maven-3.9.11-bin.tar.gz -C /opt

	# 3. 修改文件夹
	sudo mv /opt/apache-maven-3.9.11 /opt/maven

	# 4. 配置环境变量
	echo 'export M2_HOME=/opt/maven' >> ~/.bashrc
	echo 'export PATH=$M2_HOME/bin:$PATH' >> ~/.bashrc

	# 5. 使配置生效
	source ~/.bashrc

	# 6. 验证安装
	mvn -version
	```

	>不用dnf安装主要是要修改下载代理

3. 修改代理镜像

	```sh
	# 进入maven配置文件夹中
	cd /opt/maven/config
	# 备份文件
	mv settings.xml settings.xml.bak
	# 新建配置
	vim settings.xml
	# 测试代理是否生效
	mvn help:effective-settings
	```

	```xml
	<?xml version="1.0" encoding="UTF-8"?>
	<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/		xsd/settings-1.0.0.xsd">

		<!-- 阿里云镜像 -->
		<mirrors>
		<mirror>
			<id>aliyunmaven</id>
			<mirrorOf>*</mirrorOf>
			<name>阿里云公共仓库</name>
			<url>https://maven.aliyun.com/repository/public</url>
			</mirror>
		</mirrors>
		<!-- 文件位置 -->
		<localRepository>/opt/maven/MavenRepository</localRepository>
	</settings>
	```

### 1.3.3 安装git


```sh
# 添加EPEL仓库
sudo dnf install epel-release

# 安装最新版Git
sudo dnf install git

# 验证git
git --version
```

### 1.3.4 jenkins 下载安装

1. 进入官网

	- jenkins官网: [https://www.jenkins.io/](https://www.jenkins.io/)
	- jenkins官网中文(更舒服): [https://www.jenkins.io/zh/](https://www.jenkins.io/zh/)

2. 下载上传

	下载地址:[https://www.jenkins.io/download/](https://www.jenkins.io/download/)
	
	上传文件的位置 /opt/jenkins/jenkins.war

3. 启动 jenkins.war 文件 测试

	```sh
	java -jar jenkins.war --httpPort=8080
	```

	**初始化密码**

	![](/other/install/jenkins/023.png)


4. 启动脚本

	1. 准备工作（为了下载插件）

		- 安装 shadowsocks-rust 客户端 
		- 安装 privoxy 网络代理
		- 使用 `curl -I --proxy http://127.0.0.1:8118 http://www.google.com` 测试
		- 具体可查看 [安装linux (shadowsocks-rust)](/markdown/network/external/shadowsocks/02.html#_1-3-安装linux-shadowsocks-rust)
	
	2. 新建脚本 

		1. 后台脚本，用于手动启动

			```sh
			# 新建脚本
			sudo vim /opt/jenkins/start-jenkins.sh
			# 修改脚本权限
			chomd 755 /opt/jenkins/start-jenkins.sh
			# 启动脚本
			sudo sh /opt/jenkins/start-jenkins.sh
			```
		2. start-jenkins启动脚本

			```sh
			#!/bin/bash

			JENKINS_WAR="/opt/jenkins/jenkins.war" 
			HTTP_PORT=8080 
			JAVA_OPTS="-Djava.awt.headless=true -Xmx1024m"
			JENKINS_LOG="/opt/jenkins/jenkins.log"
			JENKINS_PID_FILE="/opt/jenkins/jenkins.pid"

			# 代理设置
			PROXY_HOST="127.0.0.1"
			PROXY_PORT="8118"

			# 启动Jenkins
			start() {
				echo "正在启动Jenkins..."
				nohup java $JAVA_OPTS \
					-Dhttp.proxyHost=$PROXY_HOST \
					-Dhttp.proxyPort=$PROXY_PORT \
					-Dhttps.proxyHost=$PROXY_HOST \
					-Dhttps.proxyPort=$PROXY_PORT \
					-jar "$JENKINS_WAR" \
					--httpPort=$HTTP_PORT \
					> $JENKINS_LOG 2>&1 &
				
				JENKINS_PID=$!
				echo $JENKINS_PID > $JENKINS_PID_FILE
				echo "Jenkins已启动，PID: $JENKINS_PID"
			}

			# 停止Jenkins
			stop() {
				echo "正在停止Jenkins..."
				if [ -f $JENKINS_PID_FILE ]; then
					PID=$(cat $JENKINS_PID_FILE)
					kill $PID
					rm -f $JENKINS_PID_FILE
					echo "Jenkins已停止"
				else
					echo "Jenkins未运行"
				fi
			}


			# 主逻辑
			case "$1" in
				start)
					start
					;;
				stop)
					stop
					;;
				*)
			esac
			```
	3. 前台脚本 

		- 新建脚本

			```sh
			# 新建脚本
			sudo vim /opt/jenkins/system-jenkins.sh
			# 修改脚本权限
			chomd 755 /opt/jenkins/system-jenkins.sh
			```
		- 脚本内容

			```sh
			#!/bin/bash

			JENKINS_WAR="/opt/jenkins/jenkins.war" 
			HTTP_PORT=8080
			JAVA_OPTS="-Djava.awt.headless=true -Xmx1024m"

			# 代理设置
			PROXY_HOST="127.0.0.1"
			PROXY_PORT="8118"

			echo "正在启动Jenkins..."
			echo "Jenkins日志: /opt/jenkins/jenkins.log"
			echo "HTTP端口: $HTTP_PORT"
			echo "代理: $PROXY_HOST:$PROXY_PORT"

			# 删除旧日志
			> /opt/jenkins/jenkins.log

			# 前台运行（不要用nohup和&）
			exec java $JAVA_OPTS \
			  -Dhttp.proxyHost=$PROXY_HOST \
			  -Dhttp.proxyPort=$PROXY_PORT \
			  -Dhttps.proxyHost=$PROXY_HOST \
			  -Dhttps.proxyPort=$PROXY_PORT \
			  -jar "$JENKINS_WAR" \
			  --httpPort=$HTTP_PORT \
			  > /opt/jenkins/jenkins.log 2>&1
			```

		- 加入开机自启

			```sh
			# 创建启动文件
			sudo vim /etc/systemd/system/jenkins.service
			# 重新加载systemd配置
			sudo systemctl daemon-reload
			# 设置开机自启并启动服务与检查状态
			sudo systemctl enable jenkins
			sudo systemctl start jenkins
			sudo systemctl status jenkins
			```

			```ini
			[Unit]
			Description=Jenkins CI Server
			After=network.target

			[Service]
			Type=simple
			User=root
			ExecStart=/opt/jenkins/system-jenkins.sh
			Restart=always
			RestartSec=10

			[Install]
			WantedBy=multi-user.target
			```
		- 如果和我一样使用rocky Linux 会遇到 SELinux 问题

			```sh
			sudo setenforce 0
			sudo chcon -t bin_t /opt/jenkins/start-jenkins.sh
			sudo setenforce 1
			sudo systemctl restart jenkins.service
			```

5. jenkins的初始配置

	- 输入密码

		![](/other/install/jenkins/024.png)
	- 选择推荐插件

		![](/other/install/jenkins/025.png)
	- 自己可能会用到的

		- `OWASP Markup Formatter`: HTML文本标记(jenkins自带功能之一)
		- `Build Timeout`: 构建超时控制,防止卡死构建占用资源
		- `Credentials Binding`: 凭据绑定到环境变量
		- `SSH Agent` SSH代理，部署到其他服务器
		- `Workspace Cleanup`: 构建前后清理磁盘空间
		- `NodeJS`: 打包前端包必备
		- `Junit`: 收集和展示单元测试结果
		- `Pipeline`: 定义CI/CD流水线，支持脚本式和声明式流水线
		- `Pipeline Graph View`: 流水线作业图，展示哪些步骤出错
		- `Git`: 从Git仓库拉取代码，支持GitHub、GitLab、Bitbucket等
		- `GitLab`: Webhook自动触发构建、PR检查等
		- `Subversion`: svn构建
		- `Email Extension` 电子邮件扩展
		- `Localization: Chinese (Simplified)`: 中文语言包（必装）

	- 安装中

		![](/other/install/jenkins/026.png)

	- 输入账户密码与邮箱

		![](/other/install/jenkins/027.png)
	- 实例配置（默认就可以）

		![](/other/install/jenkins/028.png)
	- 登录jenkins

		![](/other/install/jenkins/029.png)

	- 进入插件中

		![](/other/install/jenkins/030.png)

		![](/other/install/jenkins/031.png)

### 1.3.5 配置Maven+Git自动构建jar包

1. 安装maven插件

	![](/other/install/jenkins/033.png)

	![](/other/install/jenkins/034.png)

	![](/other/install/jenkins/035.png)

2. 配置maven

	![](/other/install/jenkins/036.png)

	![](/other/install/jenkins/039.png)

3. 拉取项目

	- 新建item

		![](/other/install/jenkins/037.png)

		![](/other/install/jenkins/038.png)
	- git配置

		![](/other/install/jenkins/040.png)
4. 构建项目

	- **启动构建**

		![](/other/install/jenkins/041.png)

	- **构建成功**

		![](/other/install/jenkins/042.png)

	- **控制台输出**

		![](/other/install/jenkins/045.png)

		![](/other/install/jenkins/044.png)

		构建成功以及jar包的位置

		![](/other/install/jenkins/043.png)

## 1.4 自动化发布到测试服务器并自动运行

### 1.4.1 测试服务器安装jre

```bash
#  搜索可用的 JDK 包
dnf search java | grep jdk
# 安装 JDK 开发包
dnf install java-17-openjdk.x86_64
# 验证安装
java -version
```

### 1.4.2 jenkins 安装 `Publish Over SSH`

1. 搜索插件
	
	![](/other/install/jenkins/046.png)
2. 等待安装

	![](/other/install/jenkins/047.png)
3. 安装完成

	![](/other/install/jenkins/048.png)

### 1.4.3 jenkins 配置服务器

1. 选择系统配置

	![](/other/install/jenkins/049.png)

2. 新增SHH服务器

	![](/other/install/jenkins/050.png)

3. 配置用户与密码

	![](/other/install/jenkins/051.png)

### 1.4.4 构建中后将文件传给测试服务器

1. 进入项目配置

	![](/other/install/jenkins/052.png)

2. 选择 `Send files or execute commands over SSH`

	![](/other/install/jenkins/053.png)

3. 确认jar包位置

	![](/other/install/jenkins/054.png)

4. 最基础的传递文件

	![](/other/install/jenkins/055.png)

5. 重新构建

	- 开始构建

		![](/other/install/jenkins/058.png)
	- 构建结果

		![](/other/install/jenkins/057.png)
	- 从服务器查找构建的文件

		![](/other/install/jenkins/056.png)

6. 启动jar包验证结果

	![](/other/install/jenkins/059.png)

### 1.4.5 构建配置优化

1. 构建配置-传递文件

	![](/other/install/jenkins/060.png)

2. 重新构建项目

	![](/other/install/jenkins/061.png)

3. 控制台显示（显示已超时，后续会改的）

	![](/other/install/jenkins/062.png)

4. 查看进程

	![](/other/install/jenkins/063.png)

5. 开放防火墙端口

	```sh
	# 永久开放8080端口
	firewall-cmd --add-port=8080/tcp --permanent
	# 使永久规则生效
	firewall-cmd --reload
	```
6. 页面运行效果

	![](/other/install/jenkins/064.png)