# 二、jenkins 高级配置

## 2.1 publishers 超时机制

1. 超时时间设置

	> 如果一个项目比较大，或者连接数据库初始加载数据比较慢，都要设置一个比较大的时间

	![](/other/install/jenkins/065.png)

2. 执行命令要有返回结果

	```sh
	nohup java -jar /root/xxoo/java-*.jar &
	```

	![](/other/install/jenkins/066.png)

3. 修改命令

	```sh
	nohup java -jar /root/xxoo/java-demo*.jar >mylog.log 2>&1 &
	# 或者
	nohup java -jar /root/xxoo/java-demo*.jar &>mylog.log &
	```
4. 修改后的构建结果

	![](/other/install/jenkins/067.png)

## 2.2 前置脚本

1. 添加前置处理命令

	![](/other/install/jenkins/068.png)

	![](/other/install/jenkins/069.png)

2. 添加 clear.sh 脚本

	- 新建脚本

		```sh
		# 添加脚本
		sudo vim clear.sh
		# 添加权限
		sudo chmod 755 clear.sh
		# 测试脚本
		./clear.sh java-demo
		```

	- 脚本文件
		
		```sh
		#!/bin/bash
		# 获取传入的参数
		echo "arg:$1"

		# 获取正在运行的jar包pid
		pid=`ps -ef | grep $1 | grep 'java -jar' | awk '{print $2}'`
		echo $pid

		# 如果pid为空，提示一下，否则，执行kill命令
		# 使用-z 做空值判断
		if [ -z $pid ];
		then
			echo "$1 not started"
		else
			kill -9 $pid
			echo "$1 stoping..."
		fi
		```
	- 测试结果

		![](/other/install/jenkins/070.png)
3. 重新构建

	![](/other/install/jenkins/071.png)


## 2.3 构建触发器

### 2.3.1  Jenkins 自动化构建触发方式

1. 快照依赖构建

	*   **机制**：当项目所依赖的某个 **SNAPSHOT 版本**​ 的构件被更新并构建后，自动触发当前项目的构建。
		
	*   **适用场景**：多模块项目或微服务架构中，确保依赖的“快照”版本变更后，下游项目能立即重新构建并集成。
		
	*   **配置提示**：需在 Jenkins 项目配置的 **“构建触发器”**​ 中勾选对应选项，并确保依赖项目与当前项目在同一 Jenkins 中或可被感知。


2. 触发远程构建

	*   **机制**：通过调用 Jenkins 提供的 **REST API**​ 来手动或编程式触发构建。
		
	*   **适用场景**：
		
		*  外部系统事件需要触发构建（如：外部监控告警、手动脚本执行）。
			
		*  与其他自动化工具（如运维脚本、测试平台）集成。
		
	*   **配置提示**：
		
		1.  在项目配置中启用 **“触发远程构建”**，并设置可选的令牌（Token）。
			
		2.  使用 `curl`等工具发送请求：

			```bash
			curl -X POST http://JENKINS_URL/job/JOB_NAME/build?token=TOKEN
			```

3. Job 依赖构建

	*   **机制**：当指定的上游项目（其他 Job）构建完成后，自动触发当前项目的构建。
		
	*   **适用场景**：流水线中明确的前后依赖关系，如先编译、再测试、最后部署的链式触发。
		
	*   **配置提示**：在 **“构建触发器”**​ 中选择 **“Build after other projects are built”**，并填写上游项目的名称。


4. 定时构建

	*   **机制**：使用 **Cron 表达式**​ 设置固定的时间计划，无论代码是否有变更，到时间即触发构建。
		
	*   **适用场景**：
		
		*  定期生成夜间构建（Nightly Builds）。
			
		*  周期性执行集成测试或代码质量扫描。
			
		
	*   **配置提示**：
		
		*  表达式示例：`H 2 * * *`（每天凌晨 2 点执行）。
			
		*  可在输入框旁点击 **“？”**​ 查看 Jenkins 提供的 Cron 语法帮助。
			


5. GitHub 提交代码触发构建

	*   **机制**：通过 **GitHub Webhook**，在代码推送到仓库时，GitHub 自动通知 Jenkins 触发构建。
		
	*   **适用场景**：典型的 CI 场景，实现“提交即构建”。
		
	*   **配置提示**：
		
		1.  在 GitHub 仓库设置中添加 Webhook，指向 `JENKINS_URL/github-webhook/`。
			
		2.  在 Jenkins 项目配置中勾选 **“GitHub hook trigger for GITScm polling”**。
			
6. 定期检查代码变更

	*   **机制**：结合 **Cron 表达式**​ 与 **SCM 轮询**，定期检查版本控制系统中是否有新提交，若有变更则触发构建。
		
	*   **适用场景**：当无法使用 Webhook（如 Git 仓库不支持或网络限制）时，作为替代方案。
		
	*   **配置提示**：
		
		*  在 **“构建触发器”**​ 中选择 **“Poll SCM”**。
			
		*  表达式示例：`*/5 * * * *`（每 5 分钟检查一次变更）。
			


7. **总结与建议**

	| 构建方式 | 触发条件 | 推荐场景 |
	| --- | --- | --- |
	| **快照依赖构建**​ | 依赖的 SNAPSHOT 更新 | 多模块项目协作 |
	| **触发远程构建**​ | REST API 调用 | 与外部系统集成 |
	| **Job 依赖构建**​ | 上游 Job 完成 | 明确的流水线依赖 |
	| **定时构建**​ | 时间计划（Cron） | 定期任务（如夜间构建） |
	| **GitHub 提交触发**​ | GitHub Webhook | 标准的 GitOps 流程 |
	| **定期检查代码变更**​ | SCM 轮询 + Cron | 无法使用 Webhook 时 |



### 2.3.2 触发远程构建

1. 基础使用

	- 设置令牌

		![](/other/install/jenkins/072.png)
	- URL调用

		![](/other/install/jenkins/073.png)
	- 调用结果

		```txt
		http://192.168.18.82:8080/job/first/build?token=123456
		```

		![](/other/install/jenkins/073.png)
	- 限制问题

		![](/other/install/jenkins/075.png)

		浏览器必须已经登录了jenkins，使用浏览器调用，否则不会触发

2. 解决方案：使用 `Build Authorization Token Root`

	- 安装插件

		![](/other/install/jenkins/076.png)
	- 获取地址

		![](/other/install/jenkins/087.png)

		```txt
		http://192.168.18.82:8080/buildByToken/build?job=first&token=123456
		```

	- 验证无登录是否解决

		![](/other/install/jenkins/077.png)

3. 再gitlab中的webhooks中设置触发调用

	- 设置可以集成本地网络

		1. 进入 GitLab 管理区域：
			
			管理员账号 → Admin Area​ → Settings​ → Network
		2. 展开 "Outbound requests"​ 部分
		3. 勾选： `Allow requests to the local network from hooks and services`
		4. 点击 Save changes

		![](/other/install/jenkins/082.png)

	- webhooks 设置

		**找到webhooks**

		![](/other/install/jenkins/078.png)

		**设置触发的URL**

		![](/other/install/jenkins/079.png)

		**选择提交与合并**

		![](/other/install/jenkins/080.png)

		**取消SSL并选择添加webhooks**

		![](/other/install/jenkins/080.png)
	
	- 验证结果

		- java代码

			```java
			public class HelloController {

				@RequestMapping()
				public String hello() {
					return "Hello World！！ update" ;
				}
			}
			```
		- 选择合并

			![](/other/install/jenkins/083.png)

		- 合并后 jenkins触发的构建

			![](/other/install/jenkins/083.png)

			> 可以看到触发了两次，一次是发起合并请求，一次是审批完成进行合并，并不是太好准确
		- 浏览器访问重新构建的项目

			![](/other/install/jenkins/085.png)

### 2.3.3 定时构建

1. 修改地址

	![](/other/install/jenkins/086.png)

2. jenkins中的cron表达式


	1. 基本格式

		Jenkins的Cron表达式包含5个字段，格式为：

		```markdown
		分 时 日 月 周
		```

		| 字段  | 取值范围 | 说明  |
		| --- | --- | --- |
		| **分**​ | 0-59 | 分钟  |
		| **时**​ | 0-23 | 小时  |
		| **日**​ | 1-31 | 月份中的日期 |
		| **月**​ | 1-12 | 月份  |
		| **周**​ | 0-7 | 星期几（0和7都表示周日） |

	2. 特殊字符

		| 字符  | 说明  | 示例  |
		| --- | --- | --- |
		| `*` | 所有值 | `* * * * *`每分钟 |
		| `,` | 指定多个值 | `0,30 * * * *`每小时的0分和30分 |
		| `-` | 范围  | `0 9-18 * * *`9点到18点每小时 |
		| `/` | 间隔  | `*/5 * * * *`每5分钟 |
		| `H` | 哈希值（Jenkins特有） | `H * * * *`每小时内的随机时间 |

	3. 常用示例
		-  基本定时

			```bash
			# 每天凌晨2点执行
			0 2 * * *

			# 每5分钟执行一次
			*/5 * * * *

			# 工作日的9点到18点每小时执行
			0 9-18 * * 1-5

			# 每周日凌晨1点执行
			0 1 * * 0

			# 每月1号凌晨0点执行
			0 0 1 * *
			```

		-  使用H字符（推荐）


			```bash
			# 每天随机时间执行一次
			H H * * *

			# 每天凌晨2点到3点之间的随机时间
			H 2 * * *

			# 每小时的随机分钟执行
			H * * * *

			# 工作日的9点到18点每小时随机执行
			H 9-18 * * 1-5
			```

		-  复杂场景

			```bash
			# 每30分钟执行一次
			H/30 * * * *

			# 每天10:30和22:30执行
			30 10,22 * * *

			# 每月的1号和15号凌晨2点执行
			0 2 1,15 * *

			# 每周一到周五的9:00、12:00、18:00执行
			0 9,12,18 * * 1-5
			```

	4. H字符的优势

		`H`字符是Jenkins的特有功能，用于在大型系统中分散负载：

		*   **避免集中执行**：多个任务不会在同一时间点触发
			
		*   **提高性能**：避免服务器在整点时刻负载过高
			
		*   **随机分布**：在指定时间范围内随机选择执行时间
			
3. 写一个每两分钟触发构建的cron表达式验证

	```txt
	H/2 * * * *
	```

	![](/other/install/jenkins/088.png)

4. 构建结果

	![](/other/install/jenkins/089.png)

### 2.3.4 定时检查代码

就是每隔一段时间检查一次代码是否发生改变，如果改变进行构建

1. 输入表达式

	```txt
	H/2 * * * *
	```

	![](/other/install/jenkins/090.png)

2. 修改代码

	```java
	public class HelloController {

		@RequestMapping()
		public String hello() {
			return "Hello World！！ 定时检查" ;
		}
	}
	```

3. 构建结果

	![](/other/install/jenkins/091.png)


## 2.4 邮件通知

1. 开通163邮箱的 POP3/SMTP 服务

	![](/other/install/jenkins/092.png)

2. 设置管理员邮箱（用于发邮件）

	![](/other/install/jenkins/093.png)

3. 添加邮箱配置(构建触发的邮箱)

	- 选择添加凭证

		![](/other/install/jenkins/094.png)
		
	- 凭证填写邮箱与密码

		![](/other/install/jenkins/095.png)
	- 添加后的凭证

		![](/other/install/jenkins/104.png)

	- 选择需要的事件触发器

		![](/other/install/jenkins/096.png)

4. 邮件通知(系统级错误才会发送)

	- 配置项

		![](/other/install/jenkins/097.png)
	- 测试短信

		![](/other/install/jenkins/098.png)
	- 测试结果

		![](/other/install/jenkins/099.png)

5. 项目- 构建后操作 - 添加邮箱发送用户

	- 选择添加邮箱

		![](/other/install/jenkins/101.png)
	- 高级设置

		![](/other/install/jenkins/102.png)
	- 添加构建者用户（就是初始注册用户下邮箱）

		![](/other/install/jenkins/100.png)

5. 验证

	- 构建项目

		![](/other/install/jenkins/103.png)
	- 邮箱中的邮件

		![](/other/install/jenkins/105.png)


