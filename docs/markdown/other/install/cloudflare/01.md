# 一、CloudFlare的介绍

## 一、CloudFlare 是什么？

### 1.1 核心概念

CloudFlare 是一个集 **CDN、DNS、安全防护、服务器网络** 于一体的云服务平台。

### 1.2 主要功能模块

```plain
text
```

```plain
┌─────────────────────────────────────┐
│         CloudFlare 生态            │
├─────────────────────────────────────┤
│ 1. CDN 网络          │ 5. 域名注册   │
│ 2. DNS 服务          │ 6. 邮件路由   │
│ 3. 安全防护          │ 7. 流媒体服务 │
│ 4. Workers/Pages     │ 8. Zero Trust│
└─────────────────────────────────────┘
```
### 1.3 官网

1. 进入官网

    [cloudflare.com](https://www.cloudflare.com/)

2. 直接使用功能

    [https://dash.cloudflare.com/](https://dash.cloudflare.com/)

## 二、免费套餐功能介绍

### 2.1 完全免费的核心功能

*   **CDN 加速**: 全球 300+ 节点
    
*   **DNS 管理**: 无限域名、无限解析记录
    
*   **SSL 证书**: 自动 HTTPS、支持通配符
    
*   **DDoS 防护**: 基础攻击防护
    
*   **页面缓存**: 静态资源加速
    
*   **Workers**: 10万次请求/天
    
*   **Pages**: 无限站点、自动构建部署
    
*   **R2 存储**: 10GB 免费存储
    

### 2.2 免费与付费版对比

| 功能  | 免费版 | 付费版 ($20/月) |
| --- | --- | --- |
| CDN 节点数 | 300+ | 300+ |
| DDoS 防护 | 基础  | 高级  |
| 防火墙规则 | 5条  | 免费版10倍 |
| Workers 请求 | 10万/天 | 1000万/月 |
| Pages 构建 | 500次/月 | 5000次/月 |
| R2 存储 | 10GB | 10GB+额外 |
| 分析数据 | 24小时 | 30天 |

## 三、域名接入 CloudFlare

### 3.1 添加站点步骤

1. 访问 https://dash.cloudflare.com
2. 点击 "添加站点"
3. 输入你的域名：example.com
4. 选择免费套餐
5. 复制 CloudFlare 的 DNS 服务器地址

```sh
# 通常为：
ns1.cloudflare.com
ns2.cloudflare.com
```
6. 到你的域名注册商处修改 DNS 服务器
7. 等待生效（通常 5-30分钟）


### 3.2 修改 DNS 服务器示例

- **GoDaddy 修改方法：**

    1.  登录 GoDaddy
        
    2.  我的产品 → 域名 → 管理 DNS
        
    3.  修改 DNS 服务器为 CloudFlare 提供的
        
- **阿里云修改方法：**

    1.  登录阿里云控制台
        
    2.  域名 → 管理 → 修改 DNS
        
    3.  设置自定义 DNS
    
### 3.3 DNS 配置最佳实践

**推荐的基本 DNS 记录**

```
记录类型 | 名称 | 内容 | TTL | 代理状态
---------|------|------|-----|---------
A        | @    | 服务器IP | 自动 | 代理
A        | www  | 服务器IP | 自动 | 代理
CNAME    | blog | yoursite.com | 自动 | 代理
MX       | @    | mail.example.com | 自动 | 仅DNS
TXT      | @    | v=spf1 ... | 自动 | 仅DNS
TXT      | _dmarc | v=DMARC1... | 自动 | 仅DNS
```

## 四、CloudFlare DNS 管理

### 4.1 基本 DNS 记录类型

```bash
# A 记录 - IPv4 地址
记录：@ 或 www
内容：192.0.2.1
代理状态：开启（橙色云朵）

# AAAA 记录 - IPv6 地址
记录：@ 或 www
内容：2001:db8::1
代理状态：开启

# CNAME 记录 - 别名
记录：blog
内容：your-blog.com
代理状态：开启

# MX 记录 - 邮件服务器
记录：@
内容：mail.example.com
优先级：10
代理状态：关闭（灰色云朵）

# TXT 记录 - 文本验证
记录：@
内容：v=spf1 include:_spf.google.com ~all
代理状态：关闭
```

### 4.2 批量操作技巧

```javascript
// 使用 CloudFlare API 批量管理
// 1. 获取 API Token
// 仪表盘 → 个人资料 → API 令牌 → 创建令牌

// 2. 使用 curl 批量添加记录
curl -X POST "https://api.cloudflare.com/client/v4/zones/ZONE_ID/dns_records" \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "A",
    "name": "subdomain",
    "content": "1.2.3.4",
    "ttl": 3600,
    "proxied": true
  }'
```

## 五、SSL/TLS 设置

### 5.1 SSL 模式选择

```yaml
# 仪表盘 → SSL/TLS → 概述
推荐设置：
- 加密模式：完全（严格）
- 边缘证书：始终使用 HTTPS ✅
- 自动 HTTPS 重写：✅ 开启
- TLS 1.3：✅ 启用
- 0-RTT：✅ 开启

# 证书类型：
1. 灵活SSL - 客户端到CF加密，CF到服务器不加密（不推荐）
2. 完全SSL - 全程加密，需要服务器证书
3. 完全（严格）- 全程加密+证书验证（推荐）
```

### 5.2 自动证书生成

```bash
# CloudFlare 自动为你的域名颁发 SSL 证书
# 包括：
# - 单域名证书
# - 通配符证书 (*.example.com)
# - 15年有效期（自动续期）
```

## 六、缓存配置

### 6.1 缓存级别配置

```yaml
# 仪表盘 → 缓存 → 配置
缓存级别：
- 标准：缓存静态文件
- 简化：忽略查询字符串
- 激进：缓存所有内容

推荐设置：
- 缓存级别：标准
- 浏览器缓存 TTL：4小时
- 边缘缓存 TTL：1个月

# 页面规则（免费版3条）
规则1：
URL: example.com/images/*
设置：缓存级别 - 标准

规则2：
URL: example.com/api/*
设置：边缘缓存 TTL - 不缓存

规则3：
URL: *.example.com/*
设置：SSL - 完全（严格）
```

### 6.2 清除缓存

```bash
# 仪表盘 → 缓存 → 配置 → 清除缓存
清除方式：
1. 清除所有
2. 按 URL 清除
3. 按主机名清除
4. 按标签清除

# API 清除缓存
curl -X POST "https://api.cloudflare.com/client/v4/zones/ZONE_ID/purge_cache" \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"purge_everything": true}'
```

## 七、安全防护

### 7.1 防火墙规则

```yaml
# 免费版可创建5条规则
规则示例：

1. 阻止特定国家：
表达式：ip.geoip.country in {"CN" "RU" "KP"}
操作：阻止

2. 阻止恶意爬虫：
表达式：cf.client.bot
操作：验证码

3. 保护管理后台：
表达式：http.request.uri contains "/admin"
操作：JS质询

4. 限制访问频率：
表达式：rate limit
操作：阻止

5. 阻止特定User-Agent：
表达式：http.user_agent contains "BadBot"
操作：阻止
```

### 7.2 安全级别

```yaml
# 仪表盘 → 安全性 → 设置
安全级别：
- 低：仅针对已知威胁
- 中：针对中等威胁
- 高：针对所有威胁（推荐）
- 受攻击时：最高防护

其他设置：
- 浏览器完整性检查：✅ 开启
- 隐私通行证：✅ 开启
- 邮件地址混淆：✅ 开启
```

## 八、CloudFlare Workers

### 8.1 创建第一个 Worker

```javascript
// 1. 访问 Workers & Pages
// 2. 创建 Worker

// 基本示例
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  // 获取请求信息
  const url = new URL(request.url)
  const userAgent = request.headers.get('User-Agent') || 'Unknown'
  
  // 修改响应
  const response = await fetch(request)
  const newResponse = new Response(response.body, response)
  
  // 添加自定义头
  newResponse.headers.set('X-Worker-Origin', 'CloudFlare')
  newResponse.headers.set('X-Served-By', 'Worker')
  
  return newResponse
}

// 3. 部署到：worker-name.your-account.workers.dev
```

### 8.2 Worker 路由绑定

```yaml
# 将 Worker 绑定到自定义域名
步骤：
1. Workers & Pages → 你的Worker → 触发器
2. 添加路由
3. 输入：api.example.com/*
4. 环境：生产环境

# 现在访问 api.example.com 会经过 Worker 处理
```

## 九、CloudFlare Pages

### 9.1 部署静态网站

```bash
# 1. 访问 Pages
# 2. 创建项目
# 3. 连接 Git 仓库
# 4. 配置构建设置：
- 框架预设：根据项目选择
- 构建命令：npm run build
- 输出目录：dist 或 public
- 根目录：/

# 5. 环境变量（可选）
# 6. 点击保存并部署
```

### 9.2 自定义域名

```yaml
步骤：
1. Pages → 你的项目 → 自定义域名
2. 添加自定义域名：example.com
3. CloudFlare 会自动配置 DNS
4. 等待 SSL 证书颁发

设置：
- 强制 HTTPS：✅ 开启
- HTTP/2：✅ 开启
- HTTP/3：✅ 开启
```

## 十、R2 对象存储

### 10.1 创建存储桶

```bash
# 1. R2 → 创建存储桶
# 2. 输入名称：my-bucket
# 3. 设置：
- 公共访问：按需开启
- 区域：自动

# 4. 上传文件
# 5. 获取文件 URL
```

### 10.2 与 Worker 集成

```javascript
// 在 Worker 中访问 R2
export default {
  async fetch(request, env) {
    // 获取文件
    const object = await env.MY_BUCKET.get('image.png')
    
    if (object === null) {
      return new Response('Not found', { status: 404 })
    }
    
    // 返回文件
    const headers = new Headers()
    object.writeHttpMetadata(headers)
    headers.set('etag', object.httpEtag)
    
    return new Response(object.body, {
      headers
    })
  }
}
```

## 十一、分析数据查看

### 11.1 主要分析指标

```yaml
# 仪表盘 → 分析
查看以下数据：

1. 流量分析：
- 总请求数
- 带宽使用
- 安全威胁
- 缓存命中率

2. 安全分析：
- 防火墙事件
- DDoS 攻击
- 恶意机器人

3. 性能分析：
- 加载时间
- 缓存效率
- 网络质量

# 免费版保留24小时数据
```

### 11.2 导出分析数据

```bash
# 使用 GraphQL API 导出数据
curl -X POST "https://api.cloudflare.com/client/v4/graphql" \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "query { viewer { zones(filter: {zoneTag: \"ZONE_ID\"}) { httpRequests1mGroups(limit: 10) { dimensions { datetime } sum { visits } } } } }"
  }'
```

## 十二、最佳实践建议

### 12.1 新站配置清单

```yaml
完成以下配置：

1. DNS 设置：
- [ ] 所有 A/CNAME 记录开启代理
- [ ] MX/TXT 记录关闭代理
- [ ] 检查 DNS 解析生效

2. SSL/TLS：
- [ ] 模式：完全（严格）
- [ ] 开启始终使用 HTTPS
- [ ] 开启 TLS 1.3
- [ ] 开启 0-RTT

3. 缓存设置：
- [ ] 缓存级别：标准
- [ ] 配置页面规则
- [ ] 设置合适的 TTL

4. 安全设置：
- [ ] 安全级别：高
- [ ] 配置防火墙规则
- [ ] 开启浏览器完整性检查

5. 速度优化：
- [ ] 开启 Brotli 压缩
- [ ] 开启 HTTP/2
- [ ] 开启 HTTP/3
```

### 12.2 常见问题解决

```bash
# 1. 网站显示 "重定向过多"
解决：关闭 CloudFlare 的 SSL → 服务器设置正确的 HTTPS

# 2. 部分资源无法加载
解决：检查防火墙规则 → 清除缓存 → 检查 DNS 设置

# 3. 邮件无法接收
解决：确保 MX 记录代理状态为关闭（灰色云朵）

# 4. Worker 返回 1020 错误
解决：检查 Worker 代码 → 查看日志 → 检查路由配置

# 5. API 响应慢
解决：检查缓存设置 → 考虑使用 Workers 优化 → 查看分析数据
```

## 十三、API 使用入门

### 13.1 获取 API Token

```bash
# 1. 仪表盘 → 个人资料 → API 令牌
# 2. 创建令牌
# 3. 选择权限模板或自定义
# 4. 复制 Token

# 推荐权限：
- Zone.Zone - 读取
- Zone.DNS - 编辑
- Zone.Cache Purge - 编辑
- Account.Workers Scripts - 编辑
```

### 13.2 常用 API 示例

```bash
# 获取区域信息
curl -X GET "https://api.cloudflare.com/client/v4/zones" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 添加 DNS 记录
curl -X POST "https://api.cloudflare.com/client/v4/zones/ZONE_ID/dns_records" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"type":"A","name":"test","content":"1.2.3.4","ttl":120,"proxied":false}'

# 清除缓存
curl -X POST "https://api.cloudflare.com/client/v4/zones/ZONE_ID/purge_cache" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"files":["https://example.com/style.css"]}'
```

## 十四、移动端管理

### 14.1 CloudFlare 官方 App

```yaml
# 功能：
- 实时查看分析
- 管理 DNS 记录
- 清除缓存
- 查看安全事件
- 接收通知提醒

# 下载：
- iOS: App Store 搜索 "CloudFlare"
- Android: Google Play 搜索 "CloudFlare"
```

这个指南涵盖了 CloudFlare 的核心功能和基本使用。对于大多数个人和小型项目，免费版完全足够使用。建议按照配置清单逐步设置，特别注意 SSL 和 DNS 的正确配置。