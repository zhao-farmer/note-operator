
# 正则表达式

## 一、正则表达式基础概念

### 什么是正则表达式？

**正则表达式（Regular Expression）** 是一种用于**匹配字符串中字符组合的模式**，常用于文本搜索、替换、验证和提取。

### 基本结构

```text
/模式/修饰符
^     $     .     *     +     ?
│     │     │     │     │     │
开始  结束  任意  0+次  1+次  0或1次
```

## 二、元字符完全解析

### 1. **位置锚点**

| 字符  | 描述  | 示例  | 匹配  |
| --- | --- | --- | --- |
| `^` | 字符串开始 | `^Hello` | "Hello World" 中的 "Hello" |
| `$` | 字符串结束 | `World$` | "Hello World" 中的 "World" |
| `\b` | 单词边界 | `\bword\b` | "my word test" 中的 "word" |
| `\B` | 非单词边界 | `\Bword\B` | "swordfish" 中的 "word" |

### 2. **字符类**

| 模式  | 描述  | 等价于 |
| --- | --- | --- |
| `.` | 除换行外任意字符 | \-  |
| `\d` | 数字  | `[0-9]` |
| `\D` | 非数字 | `[^0-9]` |
| `\w` | 单词字符 | `[a-zA-Z0-9_]` |
| `\W` | 非单词字符 | `[^a-zA-Z0-9_]` |
| `\s` | 空白字符 | `[ \t\n\r\f\v]` |
| `\S` | 非空白字符 | `[^ \t\n\r\f\v]` |
| `[abc]` | a、b或c | \-  |
| `[^abc]` | 非a、b、c | \-  |
| `[a-z]` | a到z | \-  |
| `[A-Z]` | A到Z | \-  |
| `[0-9]` | 数字  | `\d` |

### 3. **量词（重复次数）**

| 量词  | 描述  | 示例  | 匹配  |
| --- | --- | --- | --- |
| `*` | 0次或多次 | `a*` | "", "a", "aa", "aaa" |
| `+` | 1次或多次 | `a+` | "a", "aa", "aaa" |
| `?` | 0次或1次 | `a?` | "", "a" |
| `{n}` | 正好n次 | `a{3}` | "aaa" |
| `{n,}` | n次或更多 | `a{2,}` | "aa", "aaa", ... |
| `{n,m}` | n到m次 | `a{2,4}` | "aa", "aaa", "aaaa" |

**贪婪 vs 惰性匹配：**


```md
贪婪模式：<div>.*</div>    # 匹配最长可能的字符串
惰性模式：<div>.*?</div>   # 匹配最短可能的字符串
```

### 4. **分组和捕获**

| 模式  | 描述  | 示例  |
| --- | --- | --- | --- | --- |
| `(abc)` | 捕获分组 | `(\d{3})-(\d{4})` |
| `(?:abc)` | 非捕获分组 | `(?:\d{3})-(\d{4})` |
| `(?<name>abc)` | 命名捕获组 | `(?<area>\d{3})-(?<num>\d{4})` |
| `\n` | 反向引用 | `(\w)\1` 匹配 "aa", "bb" |
| \`  | \`  | 或运算 | \`cat | dog\` |

## 三、高级特性

### 1. **环视断言（Lookaround）**

| 断言类型 | 语法  | 描述  | 示例  |
| --- | --- | --- | --- |
| 正向前瞻 | `(?=...)` | 后面是... | `\d+(?=px)` 匹配 "10px" 中的 "10" |
| 负向前瞻 | `(?!...)` | 后面不是... | `\d+(?!px)` 匹配 "10pt" 中的 "10" |
| 正向后顾 | `(?<=...)` | 前面是... | `(?<=\$)\d+` 匹配 "$100" 中的 "100" |
| 负向后顾 | `(?<!...)` | 前面不是... | `(?<!\$)\d+` 匹配 "¥100" 中的 "100" |

### 2. **模式修饰符（标志）**

| 修饰符 | 描述  | 示例  |
| --- | --- | --- |
| `i` | 不区分大小写 | `/hello/i` 匹配 "Hello", "HELLO" |
| `g` | 全局匹配 | 查找所有匹配，不只是第一个 |
| `m` | 多行模式 | `^`和`$`匹配每行的开始/结束 |
| `s` | 单行模式 | `.`匹配包括换行符的所有字符 |
| `u` | Unicode模式 | 正确处理Unicode字符 |
| `x` | 忽略空白 | 允许添加空格和注释 |

### 3. **Unicode和特殊字符**


```shell
# Unicode字符
\u0041          # 匹配 "A"
\p{Script=Han}  # 匹配中文字符
\p{L}           # 匹配任何语言的字母

# 特殊转义
\n              # 换行符
\t              # 制表符
\r              # 回车符
\\              # 反斜杠
.              # 点号（字面量）
```

## 四、常用正则模式

### 1. **数据验证**

```bash
# 邮箱地址
^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,}$

# 手机号码（中国）
^1[3-9]\d{9}$

# 身份证号码（18位）
^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$

# 密码强度（8-20位，含大小写数字）
^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,20}$

# URL
^(https?://)?([\w-]+.)+[\w-]+(/[\w-./?%&=]*)?$

# IP地址（IPv4）
^((25[0-5]|2[0-4]\d|[01]?\d\d?).){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$

# 日期（YYYY-MM-DD）
^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$

# 时间（HH:MM:SS）
^(?:[01]\d|2[0-3]):[0-5]\d:[0-5]\d$
```

### 2. **数据提取**

```bash
# 提取所有数字
\d+(.\d+)?

# 提取价格
¥?\s*\d+(?:.\d{2})?

# 提取HTML标签内容
<([a-z][a-z0-9]*)[^>]*>(.*?)</\1>

# 提取URL中的域名
https?://([^/]+)

# 提取中文字符
[\u4e00-\u9fa5]+

# 提取注释
//.*$           # 单行注释
/\*[\s\S]*?\*/  # 多行注释
```

### 3. **文本处理**

```bash
# 删除空白行
^\s*$

# 删除HTML标签
<[^>]+>

# 删除多余空格
\s{2,}

# 单词首字母大写
\b\w

# 驼峰转下划线
([a-z])([A-Z])

# 下划线转驼峰
_([a-z])
```

## 五、性能优化技巧

### 1. **避免回溯灾难**

```bash
#  灾难性回溯
(.*)*
(a+)+
(x+x+)+y

#  优化方案
(?>.*)          # 原子分组
(?:a+)+         # 非捕获分组
x++             # 占有量词
```

### 2. **使用具体字符集**

```bash
# 低效
.*\d.*          # 包含数字的行

# 高效
[^\n]*\d[^\n]*  # 同样功能，更高效
```

### 3. **锚点优先**

```bash
# 从整个字符串开始搜索
.*abc

# 使用锚点限制范围
^.*abc          # 只从开头搜索
```

### 4. **避免过度使用.**

```bash
# 过度使用通配符
.*@.*..*       # 匹配邮箱

# 更精确的匹配
\w+@\w+.\w+    # 更高效
```

## 六、调试和测试工具

### 在线测试工具

1.  **Regex101** ([https://regex101.com/](https://regex101.com/)) - 支持多语言，有详细解释
    
2.  **RegExr** ([https://regexr.com/](https://regexr.com/)) - 交互式学习工具
    
3.  **RegexPal** ([http://regexpal.com/](http://regexpal.com/)) - 简单快速的测试工具
    
4.  **Debuggex** ([https://debuggex.com/](https://debuggex.com/)) - 可视化正则表达式
    

### 调试技巧

```python
# Python调试示例
import re

pattern = re.compile(r'''
    ^                 # 开始
    (\d{3})           # 区号
    -                 # 分隔符
    (\d{4})           # 号码
    $                 # 结束
''', re.VERBOSE)      # 详细模式，可添加注释

# 使用re.DEBUG查看解析过程
re.compile(r'\d+', re.DEBUG)
```

## 七、常见问题解决方案

### 1. **匹配多行文本**

```bash
# 默认.不匹配换行符
.*                  # ❌ 不匹配换行符

# 解决方案
[\s\S]*             # 匹配所有字符，包括换行符
(?s).*              # 单行模式，.匹配换行符
```

### 2. **懒惰匹配问题**

```bash
# 提取HTML标签内容
<.*>                # ❌ 贪婪匹配，匹配整个字符串
<.*?>               # ✅ 懒惰匹配，匹配最短的标签
```

### 3. **Unicode处理**

```bash
# 匹配所有字母（包括中文）
[a-zA-Z]            # ❌ 只匹配英文
\p{L}               # ✅ 匹配所有语言的字母（需要u标志）
```

### 4. **复杂密码验证**

```bash
# 要求：8-20位，必须包含大小写字母、数字、特殊字符
^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,20}$
```

## 八、速查表

### 基础速查

```text
.         任意字符（除换行）
^         字符串开始
$         字符串结束
\d        数字 [0-9]
\D        非数字
\w        单词字符 [a-zA-Z0-9_]
\W        非单词字符
\s        空白字符
\S        非空白字符
[abc]     a、b或c
[^abc]    非a、b、c
[a-z]     a到z
```

### 量词速查

```text
*         0次或多次
+         1次或多次
?         0次或1次
{n}       正好n次
{n,}      n次或更多
{n,m}     n到m次
*?        懒惰匹配0+次
+?        懒惰匹配1+次
```

### 分组速查

```text
(exp)         捕获分组
(?:exp)       非捕获分组
(?<name>exp)  命名分组
(?#comment)   注释
(?=exp)       正向前瞻
(?!exp)       负向前瞻
(?<=exp)      正向后顾
(?<!exp)      负向后顾
```